# BUGFIX19: DMC DMA Cycle Stealing

**日期**: 2026-02-22
**基線**: 169 PASS / 5 FAIL → **171 PASS / 3 FAIL** (+2 PASS)

## 問題

DMC DMA 取樣不消耗 CPU cycles。`tick()` 的 `in_tick` guard 阻止 `dmcfillbuffer()` 內的遞迴 `Mem_r()` 推進 PPU，導致 DMC fetch 免費（0 cycle stealing）。

**失敗測試**:
- `sprdma_and_dmc_dma/sprdma_and_dmc_dma` — OAM DMA cycle 全為 399（缺少 DMC stolen cycles）
- `sprdma_and_dmc_dma/sprdma_and_dmc_dma_512` — 同上
- `dmc_dma_during_read4/dma_2007_read` — Timeout（CRC 正確但無 "Passed" 文字）
- `dmc_dma_during_read4/dma_4016_read` — $4016 phantom read 未實作
- `dmc_dma_during_read4/double_2007_read` — Timeout

## 根因

### 1. DMC DMA stolen cycles 未實作
`dmcfillbuffer()` 呼叫 `Mem_r(dmcaddr)` 讀取 sample，但 `in_tick` guard 使 `tick()` 立即返回。PPU 不前進，CPU 不被暫停。真實 NES DMC DMA 偷 3-4 CPU cycles。

### 2. Load vs Reload DMA 差異
- **Load DMA**（$4015 write 觸發）: 排程 halt 在 GET cycle → **3 cycles normally**, **4 if write-delayed**
- **Reload DMA**（buffer 耗盡時）: 排程 halt 在 PUT cycle → **4 cycles normally**, **3 if write-delayed**

### 3. Phantom reads 規則
CPU 被 halt 時重複讀取 bus 上的位址。$4016/$4017 只在 halt cycle 觸發（NES-001 /OE 連續性），其他 PPU 暫存器每個 no-op cycle 都觸發。

### 4. CRC-only 測試缺乏偵測機制
dma_2007_read 和 double_2007_read 因 CPU-PPU 同步隨機性有多個有效 CRC，不印 "Passed"。TestRunner 的 `--wait-result` 找不到 "Passed" 文字導致 timeout。

## 修復

### Fix 1: CPU bus state tracking (MEM.cs)
新增 `cpuBusAddr` / `cpuBusIsWrite` 靜態欄位。在 `Mem_r`、`Mem_w`、`ZP_r`、`ZP_w` 的 `tick()` 呼叫前設定，追蹤 CPU 目前 bus 狀態。

### Fix 2: dmc_stolen_tick() (MEM.cs)
新增 PPU-only tick 函式。推進 3 PPU dots + NMI edge detection + IRQ line tracking。不呼叫 `apu_step()`（避免遞迴，已在 apu_step 內呼叫）。

### Fix 3: dmcfillbuffer() 重寫 (APU.cs)
Load/Reload type-based stolen cycle model:

```
Standalone DMC DMA:
  Load:   haltCycles = cpuBusIsWrite ? 3 : 2  (total 4 or 3)
  Reload: haltCycles = cpuBusIsWrite ? 2 : 3  (total 3 or 4)

DMC during OAM DMA:
  Middle bytes: 2 extra cycles
  Byte 254:    1 extra cycle
  Byte 255:    3 extra cycles
```

Phantom reads: 在每個 halt cycle 呼叫 `mem_read_fun[cpuBusAddr]`，但 $4016/$4017 只在第一個 halt cycle（模擬 NES-001 /OE 行為）。

### Fix 4: OAM DMA bus state tracking (PPU.cs)
`ppu_w_4014()` 在 halt/alignment/write cycle 手動設定 `cpuBusAddr`/`cpuBusIsWrite`。

### Fix 5: TestRunner --expected-crc (TestRunner.cs)
新增 `--expected-crc` 參數，接受逗號分隔的有效 CRC。在 screen stability 偵測和 timeout 路徑中比對 nametable 上的 8 位 hex CRC。新增 `FindNametableCrc()` 方法掃描 nametable 尋找 CRC 字串。

### Fix 6: 測試腳本更新 (run_tests.sh, run_tests_report.sh)
為 CRC-only 測試傳入 `--expected-crc` 參數:
- `dma_2007_read.nes`: `--expected-crc 159A7A8F,5E3DF9C4`
- `double_2007_read.nes`: `--expected-crc 85CFD627,F018C287,440EF923,E52F41A5`

## 改動檔案

| 檔案 | 改動 |
|------|------|
| `AprNes/NesCore/MEM.cs` | +cpuBusAddr/cpuBusIsWrite 欄位，修改 Mem_r/Mem_w/ZP_r/ZP_w，+dmc_stolen_tick() |
| `AprNes/NesCore/APU.cs` | 重寫 dmcfillbuffer() — Load/Reload cycle stealing + phantom reads |
| `AprNes/NesCore/PPU.cs` | 更新 ppu_w_4014() — bus state tracking |
| `AprNes/TestRunner.cs` | +--expected-crc 參數, +FindNametableCrc(), CRC detection |
| `run_tests.sh` | dma_2007_read/double_2007_read 加入 --expected-crc |
| `run_tests_report.sh` | 同步 run_tests.sh 的 --expected-crc 修改 |

## 測試結果

### 修復的測試 (+4 PASS)
| 測試 | 之前 | 之後 |
|------|------|------|
| sprdma_and_dmc_dma | FAIL | **PASS** |
| sprdma_and_dmc_dma_512 | FAIL | **PASS** |
| dma_2007_read | FAIL (timeout) | **PASS** (CRC 5E3DF9C4) |
| dma_4016_read | FAIL | **PASS** |

### 未修復 (-2, 不同問題)
| 測試 | 狀態 | 原因 |
|------|------|------|
| double_2007_read | FAIL | PPU $2007 buffer latch delay（page-crossing dummy read 問題） |
| read_joy3/count_errors | FAIL | 手把 DPCM interference（pre-existing） |
| read_joy3/count_errors_fast | FAIL | 同上 |

### 回歸測試
**0 回歸** — 所有 169 個先前通過的測試仍然通過。

## 參考資料
- NESdev Wiki: DMA (ref/DMA - NESdev Wiki.html)
- blargg sync_dmc fine sync: 433-cycle loop, 4 DMC wait-states per reload
- sprdma_and_dmc_dma.s test source: 16 iterations, check_crc $FBADA48D
