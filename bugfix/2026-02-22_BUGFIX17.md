# BUGFIX17: Sprite timing — per-pixel hit detection + cycle-accurate overflow + hardware bug

**日期**: 2026-02-22
**基線**: 161 PASS / 13 FAIL → **165 PASS / 9 FAIL** (+4 PASS)

## 問題

- `sprite_hit_tests/09.timing_basics` — FAILED #3: upper-left corner sprite 0 hit too late
- `sprite_hit_tests/10.timing_order` — FAILED #3: upper-left corner sprite 0 hit too late
- `sprite_overflow_tests/3.Timing` — FAILED #5: overflow flag set too late for first scanline
- `sprite_overflow_tests/4.Obscure` — FAILED #2: sprite overflow hardware bug (byte offset) not implemented

## 根因

### 1. Sprite 0 hit 延遲 (tests 09, 10)

`RenderBGTile()` 在 phase 7（cycle 7, 15, 23...）批次渲染 8 個像素並檢查 sprite 0 hit。如果 hit 在 pixel 0，flag 要到 cycle 7 才設定。真實 NES 每個 dot 就檢查，最早 dot 2。延遲最多 7 PPU dots。

### 2. Sprite overflow 在 cycle 257 設定 (test 3)

`RenderSpritesLine()` 在 cycle 257 掃描全部 64 sprites 並立即設 overflow。真實 NES 的 sprite evaluation 在 dots 65-256：in-range sprite 耗 8 cycles，out-of-range 耗 2 cycles。9 sprites at Y=0 應在 ~cycle 129 設定 overflow。

### 3. Overflow bug 未實作 (test 4)

找到 8 sprites 後，真實 NES PPU 有 bug：byte offset m 隨 sprite index n 遞增（mod 4），導致讀取 tile/attr/X bytes 作為 Y 座標。我們一直從 byte 0 (Y) 讀取。

## 修復 (PPU.cs)

### Fix 1: Per-pixel sprite 0 hit detection

- 從 `RenderBGTile()` 移除 sprite 0 hit 檢查
- 在 `ppu_step_new()` 的 `ppu_rendering_tick()` **之前**加入逐 dot 偵測（dot 2-255）
- 利用 shift register 在 phases 0-6 持有上一次 phase 7 載入值的特性，計算當前 dot 的 BG pixel

### Fix 2: Cycle-accurate sprite overflow

- 新增 `PrecomputeOverflow()` 函式，在每個 visible scanline 的 cycle 0 呼叫
- 模擬 NES sprite evaluation timing：dot 65 開始，in-range 8 cycles，out-of-range 2 cycles
- 記錄 overflow 應設定的 cycle，在 `ppu_step_new()` 每個 cycle 檢查

### Fix 3: Sprite overflow hardware bug

- 在 `PrecomputeOverflow()` 中，找到 8 sprites 後：
  - 第 9 個 sprite 正常讀 byte 0 (Y)
  - 如果不在 range：n++ 同時 m = (m+1) & 3
  - 後續讀取 byte m（cycles through 1→2→3→0→1...）
- 從 `RenderSpritesLine()` 移除舊的 overflow 偵測邏輯

## 驗證

```
=== FINAL RESULTS ===
PASS: 165 / TOTAL: 174 / FAIL: 9

Sprite 全部通過:
- sprite_hit_tests: 11/11 PASS
- sprite_overflow_tests: 5/5 PASS

剩餘 9 FAIL（均為已知 Bug E/F）:
- cpu_interrupts_v2: 4 FAIL (NMI/BRK/DMA 交互)
- dmc_dma_during_read4: 3 FAIL (DMC DMA cycle stealing)
- sprdma_and_dmc_dma: 2 FAIL (DMA cycle counting)
```
