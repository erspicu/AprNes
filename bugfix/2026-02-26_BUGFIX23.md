# BUGFIX 23 – AprNesAOT UI 完整移植與修復

**日期**：2026-02-26  
**版本**：AprNesAOT v1.0 (Native AOT)  
**分類**：Bug Fix / Feature Port  

---

## 問題一：AprNesAOT 視窗空白，無任何 UI 元件

**現象**：  
視窗可以開啟（標題列正常），但視窗內容完全空白，無選單列、無提示文字、無任何操作入口。

**根本原因**：  
`Program.cs` 初版只建立了空白視窗，未加入 Win32 選單列（`CreateMenu`）和文字提示（`DrawTextW`）。

**修復**：  
- 加入完整選單列：`檔案(F)` / `選項(O)` / `語言(L)` / `說明(H)`  
- 加入 `OpenRomDialog()`（使用 `GetOpenFileNameW`）  
- 無 ROM 時 `WM_PAINT` 顯示提示文字  

---

## 問題二：開啟幾秒後程式崩潰（EntryPointNotFoundException）

**現象**：  
```
Unhandled exception. System.EntryPointNotFoundException:
Unable to find an entry point named 'SetBkMode' in DLL 'user32.dll'.
```
程式啟動後短短幾秒（第一次 `WM_PAINT` 無 ROM 時）即崩潰。

**根本原因**：  
`SetBkMode` 和 `SetTextColor` 是 **GDI 函式**，位於 `gdi32.dll`，但 P/Invoke 宣告中誤寫為 `user32.dll`：

```csharp
// ❌ 錯誤
[DllImport("user32.dll")] static extern nint SetBkMode(nint hdc, int mode);
[DllImport("user32.dll")] static extern uint SetTextColor(nint hdc, uint color);
```

**修復**：
```csharp
// ✅ 正確
[DllImport("gdi32.dll")] static extern nint SetBkMode(nint hdc, int mode);
[DllImport("gdi32.dll")] static extern uint SetTextColor(nint hdc, uint color);
```

**影響範圍**：`AprNesAOT/Program.cs`  
**修復 commit**：`2d729a1`

---

## 功能新增：AprNesAOT 完整 UI 移植（對應原 WinForms 功能）

原始 AprNes 使用 WinForms，無法在 Native AOT 使用，故以純 Win32 P/Invoke 重新實作以下功能：

### 選單結構

```
檔案(F)
  ├─ 開啟 ROM (O)
  ├─ ─────────────
  ├─ 軟重置 (S)       ← 載入 ROM 後才啟用
  ├─ 硬重置 (H)       ← 載入 ROM 後才啟用
  ├─ ─────────────
  └─ 結束 (X)

選項(O)
  ├─ 音效 (S)         ← 勾選切換
  ├─ 音量 (V) ►
  │    ├─ 10% / 30% / 50% / 70% / 90% / 100%  (Radio)
  ├─ ─────────────
  └─ 限制 FPS (F)     ← 勾選切換

語言(L)
  └─ (從 AprNesLang.ini 動態產生，勾選目前語言)

說明(H)
  ├─ ROM 資訊 (I)     ← 載入 ROM 後才啟用
  └─ 關於 (A)
```

### 其他功能

| 功能 | 說明 |
|------|------|
| FPS 標題列顯示 | `AprNes AOT  [rom名稱]  FPS: 60`，WM_TIMER 每秒更新 |
| 設定讀寫 | 讀寫 `AprNes.ini`（按鍵/音效/音量/FPS限制/語言） |
| 按鍵對應 | 從 ini 載入 `_keyMap[8]`，與原版格式相同 |
| ROM 資訊對話框 | 顯示 Mapper / PRG / CHR / 鏡像 / 電池 |
| 軟重置 | `NesCore._event.Reset()` → `SoftReset()` → `Set()` |
| 硬重置 | 停止模擬執行緒 → `NesCore.init()` 重新初始化 → 重啟 |
| 拖曳載入 ROM | `WM_DROPFILES`（保留原功能） |
| 語言切換 | 選取後寫入 ini，提示重啟 |

### 新增 NesCore 公開屬性（Main.cs）

```csharp
static public int  RomMapper   => mapper;
static public int  RomPrgCount => PRG_ROM_count;
static public int  RomChrCount => CHR_ROM_count;
static public bool RomHorizMirror => (ROM_Control_1 & 1) == 0;
static public bool LimitFPS = false;
```

---

## 文件新增

新增遷移指南：`report/dotnet_framework_to_net8_aot_migration.md`  
涵蓋 .NET Framework → .NET 8 AOT 的 11 項相容性問題與解決方案。

---

## 修改檔案清單

| 檔案 | 變更類型 |
|------|---------|
| `AprNesAOT/Program.cs` | 重寫（完整 Win32 UI） |
| `AprNes/NesCore/Main.cs` | 新增 ROM 資訊 properties + LimitFPS |
| `report/dotnet_framework_to_net8_aot_migration.md` | 新增文件 |

## 相關 Commits

| Commit | 說明 |
|--------|------|
| `929353e` | 加入選單列、Open 對話框、提示文字 |
| `ea3ffd0` | 完整 UI 移植（音效/音量/語言/重置/ROM資訊） |
| `2d729a1` | **bugfix**: SetBkMode/SetTextColor 改至 gdi32.dll |
| `22d9f5c` | 新增 AOT 遷移文件 |
