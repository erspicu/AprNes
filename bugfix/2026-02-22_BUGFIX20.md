# BUGFIX20: PPU $2007 Read Cooldown

**日期**: 2026-02-22
**基線**: 171 PASS / 3 FAIL → **172 PASS / 2 FAIL** (+1 PASS)

## 問題

CPU 頁面跨越時的 dummy read 到 $2007 立即更新 PPU buffer 和 vram_addr。真實 NES PPU 在 $2007 read 後有 6 PPU dot (~2 CPU cycle) 的 cooldown，期間連續的 $2007 read 返回 open bus 而不觸發 buffer swap 和 vram_addr increment。

**失敗測試**:
- `dmc_dma_during_read4/double_2007_read` — CRC D84F6815（期望 85CFD627/F018C287/440EF923/E52F41A5）

## 根因

### 1. CPU 0xBD (LDA abs,X) 頁面跨越

```asm
ldx #$10
lda $20F7,x   ; $F7+$10 wraps → dummy read $2007 + real read $2107
               ; $2107 也映射到 PPU $2007 ($2000-$3FFF 每 8 bytes mirror)
```

CPU 在兩個連續 cycle 內讀取 $2007 兩次：
- Cycle 3: `Mem_r($2007)` → buffer swap #1, vram_addr++
- Cycle 4: `Mem_r($2107)` → buffer swap #2, vram_addr++ （應被抑制）

### 2. 真實 NES 行為

PPU 在 $2007 read 後設定 ~6 PPU dot 的 cooldown。在 cooldown 期間，後續 $2007 read 返回 open bus value，不觸發任何副作用。

### 3. Mesen2 參考 (NesPpu.cpp)

- `_ignoreVramRead = 6` 在正常 $2007 read 後設定 (line 396)
- 每 PPU dot 遞減 1 (lines 1498-1503)
- `_ignoreVramRead > 0` 時返回 `openBusMask = 0xFF`（全 openbus, line 375-378）
- DMA phantom reads 也通過同一 ReadRam handler，受 cooldown 影響

## 修復

### Fix 1: ppu2007ReadCooldown 欄位 (PPU.cs)

新增 `static int ppu2007ReadCooldown = 0` 欄位。

### Fix 2: ppu_r_2007() cooldown 檢查 (PPU.cs)

```csharp
static byte ppu_r_2007()
{
    if (ppu2007ReadCooldown > 0)
        return openbus; // suppress: no buffer update, no vram_addr increment
    byte result = ppu_read_fun[vram_addr](vram_addr);
    ppu2007ReadCooldown = 6; // 6 PPU dots ≈ 2 CPU cycles
    return result;
}
```

### Fix 3: ppu_step_new() decrement (PPU.cs)

在 `ppu_step_new()` 開頭加入每 dot 遞減：
```csharp
if (ppu2007ReadCooldown > 0) ppu2007ReadCooldown--;
```

### Fix 4: DMC phantom reads bypass cooldown (APU.cs)

DMC DMA phantom reads 每個都是獨立 bus transaction，應有完整副作用。在 `dmcfillbuffer()` 的 phantom read 前清除 cooldown：
```csharp
ppu2007ReadCooldown = 0; // DMA phantom reads bypass $2007 read cooldown
```

## 改動檔案

| 檔案 | 改動 |
|------|------|
| `AprNes/NesCore/PPU.cs` | +ppu2007ReadCooldown 欄位, ppu_r_2007() cooldown 檢查, ppu_step_new() decrement |
| `AprNes/NesCore/APU.cs` | dmcfillbuffer() phantom read 前清除 cooldown |

## 測試結果

### 修復的測試 (+1 PASS)
| 測試 | 之前 | 之後 |
|------|------|------|
| double_2007_read | FAIL (CRC D84F6815) | **PASS** (CRC F018C287) |

### CRC 變更（仍通過）
| 測試 | 之前 CRC | 之後 CRC | 狀態 |
|------|---------|---------|------|
| dma_2007_read | 5E3DF9C4 | 159A7A8F | **PASS**（兩者皆為有效 CRC）|

### 未修復（不同問題）
| 測試 | 狀態 | 原因 |
|------|------|------|
| read_joy3/count_errors | FAIL | 手把 DPCM interference（pre-existing）|
| read_joy3/count_errors_fast | FAIL | 同上 |

### 回歸測試
**0 回歸** — 所有 171 個先前通過的測試仍然通過。
`dmc_dma_during_read4` 套件達成 **5/5 全數通過**。

## 參考資料
- Mesen2: NesPpu.cpp `_ignoreVramRead` (lines 375-396, 1498-1503)
- NESdev Wiki: PPU registers ($2007 read behavior)
- double_2007_read.s test source: page-crossing LDA abs,X to $2007
