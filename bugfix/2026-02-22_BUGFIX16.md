# BUGFIX16: MMC3 scanline timing — A12 notification phase alignment

**日期**: 2026-02-22
**基線**: 159 PASS / 15 FAIL → **161 PASS / 13 FAIL** (+2 PASS)

## 問題

- `mmc3_test/4-scanline_timing` — FAIL #3: "Scanline 0 IRQ should occur sooner when $2000=$08"
- `mmc3_test_2/4-scanline_timing` — 同上

## 根因

PPU rendering pipeline 中 A12 通知的時機偏晚。真實 NES 的 A12 rising edge 在 address setup 階段就出現，但模擬器在較晚的 phase 才通知 mapper。

測試校準值：
- `scanline_0_08 = 6976`（BG at $0000, sprites at $1000）
- `scanline_0_10 = 6720`（BG at $1000, sprites at $0000）
- 差值 = 256 PPU cycles = sprite fetch 起點 (cx=260) - BG CHR fetch 起點 (cx=4)

$2000=$08 時，A12 第一次上升來自 sprite CHR fetch。每條 scanline 的 sprite fetch 從 dot 257 開始，8 cycles 一組。Phase 3 (cx=260) 是 sprite CHR address 在 bus 上的正確時機。

## 修復 (PPU.cs `ppu_rendering_tick()`)

### BG tile fetch (dots 0-255, 320-335)
- Phase 0: NT address → `NotifyMapperA12(ioaddr)` (A12=0)
- Phase 4: CHR low address → `NotifyMapperA12(ioaddr)` (A12=BG table bit)

### Sprite fetch (dots 257-319)
- Phase 0: garbage NT → `NotifyMapperA12(0x2000)` (A12=0)
- Phase 3: sprite CHR → `NotifyMapperA12(SpPatternTableAddr)` (A12=sprite table bit)

### Garbage NT (dots 336-339)
- Dot 336: `NotifyMapperA12(0x2000)` (A12=0)

關鍵改動：sprite A12=1 通知從 phase 4 (cx=261) 移到 phase 3 (cx=260)，使 $2000=$08 模式下 scanline 0 的 IRQ 提前 1 PPU cycle。

## 驗證

```
=== RESULTS: 161 PASS / 13 FAIL / 174 TOTAL ===

MMC3 全部通過:
- mmc3_irq_tests: 6/6 PASS
- mmc3_test: 6/6 PASS
- mmc3_test_2: 6/6 PASS
```

## 附帶改進: run_tests_report.sh 重構

- 新增 `--json`, `--screenshots`, `--no-build` 參數
- 修正 merged test max-wait 60→120（與 run_tests.sh 一致）
- 同步 run_tests.sh 加入 mmc3 測試（+18 tests → 174 TOTAL）
