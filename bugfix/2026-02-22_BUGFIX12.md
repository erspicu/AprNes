# AprNes Bug 修復紀錄（第十二輯）

本文件接續 `BUGFIX11.md`（Bug 36），記錄 Bug 37。

---

## 目錄

37. [PPU VBL/NMI 時序修復 — 1-cycle NMI delay model](#37-ppu-vblnmi-時序修復--1-cycle-nmi-delay-model)

---

## 37. PPU VBL/NMI 時序修復 — 1-cycle NMI delay model

### 現象

139 PASS / 35 FAIL。PPU VBL flag 設定/清除時序和 NMI 邊緣檢測機制不正確，導致 14 個測試失敗：

| 測試 ROM | 錯誤 |
|----------|------|
| ppu_vbl_nmi/ppu_vbl_nmi | 合併 ROM 失敗 |
| ppu_vbl_nmi/02-vbl_set_time | VBL flag 設定/抑制時序不正確 |
| ppu_vbl_nmi/04-nmi_control | "Immediate occurrence should be after NEXT instruction" (#11) |
| ppu_vbl_nmi/05-nmi_timing | NMI 觸發指令偏差（全部 -1） |
| ppu_vbl_nmi/06-suppression | VBL suppression 窗口 + NMI 取消行為不正確 |
| ppu_vbl_nmi/07-nmi_on_timing | NMI enable timing 錯誤 |
| ppu_vbl_nmi/08-nmi_off_timing | NMI disable timing 全為 dash |
| ppu_vbl_nmi/10-even_odd_timing | "Clock is skipped too late" (#3) |
| vbl_nmi_timing/5-nmi_suppression | NMI suppression 窗口 |
| vbl_nmi_timing/6-nmi_disable | NMI 停用時序 |
| vbl_nmi_timing/7-nmi_timing | NMI 觸發時序 |

### 根本原因

#### 1. 缺少 NMI 邊緣檢測模型

原始實作在 `ppu_step_new()` 中直接設定 `nmi_pending`，缺少 hardware-level 的邊緣檢測機制。真實 NES 的 NMI 是 edge-sensitive：PPU 輸出 `nmi_output = isVblank && NMIable`，CPU 在上升沿偵測後延遲 1 CPU cycle 才觸發 NMI。

#### 2. VBL clear 時間偏差

VBL flag 清除在 `(sl=261, cx=1)` 但正確值為 `(sl=261, cx=2)`，導致 VBL 比 hardware 早 1 PPU dot 清除。

#### 3. $2002 讀取缺少 VBL flag 抑制

在 VBL 設定的同一 PPU dot `(sl=241, cx=1)` 讀取 $2002 時，VBL flag 已被設定，但 hardware 行為應回傳 VBL=0（flag 被抑制）。

#### 4. NMI 取消語義錯誤

- `$2002` 讀取和 `$2000` 寫入都直接清除 `nmi_pending`
- 但 hardware 行為是：一旦 NMI 完成 1-cycle 延遲被 promote 為 pending 狀態，**$2002 讀取不可取消**它
- `$2000` 停用 NMI 可以取消已 promote 的 NMI，但只有在 NMI 尚未在指令邊界被服務前才有效

### 修復方式 — 1-cycle NMI delay model

核心概念：引入 `nmi_delay` 中間狀態，模擬 hardware 的 1 CPU cycle 延遲：

```
上升沿偵測 → nmi_delay = true → 下次 tick() promote → nmi_pending = true → NMI 觸發
```

#### 1. MEM.cs — tick() 重寫為 per-dot 邊緣檢測 + 延遲 promote

```csharp
static void tick()
{
    if (in_tick) return;
    in_tick = true;

    // Promote nmi_delay from previous cycle → nmi_pending (1-cycle hardware delay)
    if (nmi_delay) { nmi_pending = true; nmi_delay = false; }

    // Per-dot NMI edge detection: rising edge → nmi_delay (not nmi_pending)
    for (int i = 0; i < 3; i++)
    {
        ppu_step_new();
        bool nmi_output = isVblank && NMIable;
        if (nmi_output && !nmi_output_prev)
            nmi_delay = true;       // Rising edge → 1-cycle delay before pending
        nmi_output_prev = nmi_output;
    }

    apu_step();
    in_tick = false;
}
```

**關鍵設計**:
- Per-dot 邊緣檢測：在每個 PPU dot 後檢查 `nmi_output`（非一次性在 tick 結尾）
- 上升沿設定 `nmi_delay`（非直接 `nmi_pending`）
- 每次 tick 開頭 promote `nmi_delay` → `nmi_pending`（1 CPU cycle 延遲）

#### 2. PPU.cs — VBL clear 修正

```csharp
// 舊:
if (scanline == 261 && ppu_cycles_x == 1)
    isVblank = isSprite0hit = isSpriteOverflow = false;

// 新:
if (scanline == 261 && ppu_cycles_x == 2)
    isVblank = isSprite0hit = isSpriteOverflow = false;
```

#### 3. PPU.cs — ppu_r_2002() VBL 抑制 + NMI 取消語義

```csharp
static byte ppu_r_2002()
{
    bool vblFlag = isVblank;

    // VBL suppression: 在 VBL 設定的同一 dot 讀取 → flag 回傳 0
    if (scanline == 241 && ppu_cycles_x == 1)
        vblFlag = false;

    openbus = (byte)((vblFlag ? 0x80 : 0) | ...);

    isVblank = false;
    nmi_delay = false;         // 取消未 promote 的 NMI（同一 cycle 的邊緣）
    nmi_output_prev = false;   // 重置邊緣狀態
    // 注意: 不清除 nmi_pending — 一旦 promote，$2002 讀取不可取消
    vram_latch = false;
    return openbus;
}
```

#### 4. PPU.cs — ppu_w_2000() falling edge 語義

```csharp
// Falling edge (disable NMI):
// - 清除 nmi_delay (未 promote 的可取消)
// - 不清除 nmi_pending (已 promote 的不可取消)
bool nmi_output = isVblank && NMIable;
if (!nmi_output && nmi_output_prev)
{
    nmi_delay = false;
    nmi_output_prev = false;
}
```

#### 5. PPU.cs — ppu_step_new() VBL set 簡化

```csharp
if (scanline == 241 && ppu_cycles_x == 1)
{
    if (!SuppressVbl)
        isVblank = true;
    // 不再直接設定 nmi_pending — 由 tick() 邊緣檢測處理
    SuppressVbl = false;
}
```

### 時序驗證

#### test 06 (suppression) — offset 05 vs 07 的關鍵差異

**offset 05 (V -, 正確不觸發)**:
1. tick() 的 dot 1: VBL set → nmi_delay = true
2. 同一 cycle 的 $2002 read: 清除 nmi_delay → 無 promote → 無 NMI ✓

**offset 07 (V N, 正確觸發)**:
1. cycle N tick(): VBL set → nmi_delay = true
2. cycle N+1 tick(): promote nmi_delay → nmi_pending = true
3. $2002 read: 清除 nmi_delay（已為 false），**不清除** nmi_pending → NMI 觸發 ✓

#### test 08 (nmi_off_timing) — offset 06 vs 07 的關鍵差異

**offset 06 (-, 正確不觸發)**:
1. 同一 cycle: VBL set → nmi_delay = true
2. $2000 disable: 清除 nmi_delay → 無 promote → 無 NMI ✓

**offset 07 (N, 正確觸發)**:
1. cycle N: VBL set → nmi_delay = true
2. cycle N+1: promote → nmi_pending = true
3. $2000 disable: 只清除 nmi_delay（已為 false），**不清除** nmi_pending → NMI 觸發 ✓

### 涉及檔案

| 檔案 | 改動摘要 |
|------|---------:|
| `NesCore/MEM.cs` | tick() 重寫: per-dot edge detection, nmi_delay promote |
| `NesCore/PPU.cs` | 新增 nmi_delay; VBL clear cx=1→2; ppu_r_2002 flag 抑制+不清 nmi_pending; ppu_w_2000 falling edge 不清 nmi_pending; ppu_step_new 移除直接 nmi_pending 設定 |
| `NesCore/CPU.cs` | ResetInterrupt 清除 nmi_delay |
| `NesCore/Main.cs` | 移除舊的 nmi_delay promotion code（已由 tick 處理） |

### 測試結果

| 指標 | 修復前 | 修復後 |
|------|--------|--------|
| PASS | 139 | 154 |
| FAIL | 35 | 20 |
| TOTAL | 174 | 174 |
| **改善** | — | **+15 PASS, 0 退化** |

#### 新通過的 15 個 ROM

| ROM | 修復原因 |
|-----|---------:|
| ppu_vbl_nmi/ppu_vbl_nmi | 合併 ROM（全部子測試通過） |
| ppu_vbl_nmi/02-vbl_set_time | VBL flag 抑制 (cx=1 回傳 VBL=0) |
| ppu_vbl_nmi/04-nmi_control | 1-cycle delay 使 NMI 在 NEXT instruction 後觸發 |
| ppu_vbl_nmi/05-nmi_timing | 1-cycle delay 修正 NMI 觸發指令偏差 |
| ppu_vbl_nmi/06-suppression | nmi_delay/nmi_pending 分離語義 |
| ppu_vbl_nmi/07-nmi_on_timing | Per-dot edge detection + delay |
| ppu_vbl_nmi/08-nmi_off_timing | $2000 falling edge 不清 nmi_pending |
| ppu_vbl_nmi/10-even_odd_timing | VBL clear cx=2 修正 |
| vbl_nmi_timing/2-vbl_timing | VBL set/clear 時序修正 |
| vbl_nmi_timing/3-even_odd_frames | Even/odd frame timing 修正 |
| vbl_nmi_timing/4-vbl_clear_timing | VBL clear cx=2 修正 |
| vbl_nmi_timing/5-nmi_suppression | 1-cycle delay + suppression |
| vbl_nmi_timing/6-nmi_disable | Falling edge 語義修正 |
| vbl_nmi_timing/7-nmi_timing | 1-cycle delay 修正 |
| blargg_ppu_tests/vbl_clear_time | VBL clear cx=2 修正 |

---

*最後更新: 2026-02-22*
