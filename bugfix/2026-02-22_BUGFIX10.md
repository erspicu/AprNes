# AprNes Bug 修復紀錄（第十輯）

本文件接續 `BUGFIX9.md`（Bug 34），記錄 Bug 35。

---

## 目錄

35. [DMC Timer Down-Counter：$4010 速率更改不重置倒數](#35-dmc-timer-down-counter4010-速率更改不重置倒數)

---

## 35. DMC Timer Down-Counter：$4010 速率更改不重置倒數

### 現象

134 PASS / 40 FAIL。DMC 速率測試失敗：

| 測試 ROM | 錯誤 |
|----------|------|
| apu_test/8-dmc_rates | "Rate 0's period is too long" (#3) |
| apu_test/apu_test | 因 test 8 失敗而整體 FAIL |

### 根本原因

模擬器的 DMC timer 使用 **up-counter（遞增計數器）** 搭配 modulo：

```csharp
// 舊:
dmcpos = (dmcpos + 1) % dmcrate;
if (dmcpos == 0) { /* fire */ }
```

問題：當 `$4010` 寫入更改 `dmcrate` 時（例如從 54 改為 428），modulo 運算會立即以新的 period 計算，導致當前倒數被「重置」到新 period 的起點。

真實 NES 的 DMC timer 是 **down-counter（遞減計數器）**：

1. timer 從 period 值開始遞減
2. 遞減到 0 時 fire（輸出 unit 推進一步）並 reload
3. `$4010` 寫入只改變 **reload 值**，不影響當前倒數

### 影響分析

測試 ROM `8-dmc_rates` 使用 `sync_dmc_fast` 同步 DMC timer（rate 54），然後切換到目標速率（例如 rate 0 = 428）開始播放 17 bytes 樣本。

**Up-counter 行為**（錯誤）：
- sync 後 dmcpos ≈ 30（在 rate 54 的位置）
- rate 改為 428 後，下一次 fire 在 428 - 30 = **398 cycles 後**
- 總播放時間多出約 344 cycles → "too long"

**Down-counter 行為**（正確）：
- sync 後 timer 剩餘 ≈ 24（rate 54 的倒數值）
- rate 改為 428，但倒數繼續：24, 23, ..., 0 → fire
- 第一次 fire 在 **24 cycles 後**，之後 reload 為 428
- 總時間精確匹配測試預期

### 修復方式

#### 1. APU.cs — 替換 dmcpos 為 dmctimer

```csharp
// 舊:
static int dmcrate = 0x36, dmcpos = 0, ...

// 新:
static int dmcrate = 0x36, dmctimer = 0x36, ...
```

#### 2. APU.cs — clockdmc() 改為遞減計數

```csharp
// 舊:
dmcpos = (dmcpos + 1) % dmcrate;
if (dmcpos == 0)
{
    // fire
}

// 新:
if (--dmctimer <= 0)
{
    dmctimer = dmcrate; // reload with current period
    // fire
}
```

#### 3. APU.cs — initAPU() 更新初始化

```csharp
// 舊:
dmcrate = dmcperiods[0]; dmcpos = 0;

// 新:
dmcrate = dmcperiods[0]; dmctimer = dmcrate;
```

#### 4. apu_4010() 不需修改

```csharp
// $4010 只改 reload 值，不影響 dmctimer
static void apu_4010(byte val)
{
    dmcirq  = (val & 0x80) != 0;
    if (!dmcirq) statusdmcint = false;
    dmcloop = (val & 0x40) != 0;
    dmcrate = dmcperiods[val & 0x0F]; // 只改 reload 值
}
```

### 時序驗證

測試公式：`delay = period*8*17 - period - 65`

對 rate 0 (period=428)：
```
sync_dmc_fast 後 timer 剩餘 ≈ 24 (rate 54 的倒數)
rate 改為 428, timer 繼續倒數
$4015 enable 後 timer ≈ 18

第一次 fire: ~18 cycles 後 (reload 428)
Fire 136: 18 + 135*428 = 57798

First $4015 read at: 428*135 - 65 + 4 = 57719
  57798 > 57719 → still playing ✓

Second $4015 read at: 57719 + 90 = 57809
  57798 < 57809 → done ✓
```

### 涉及檔案

| 檔案 | 改動摘要 |
|------|---------:|
| `NesCore/APU.cs` | dmcpos → dmctimer，clockdmc() 改為 down-counter，initAPU 初始化 |

### 測試結果

| 指標 | 修復前 | 修復後 |
|------|--------|--------|
| PASS | 134 | 136 |
| FAIL | 40 | 38 |
| TOTAL | 174 | 174 |
| **改善** | — | **+2 PASS, 0 退化** |

#### 新通過的 2 個 ROM

| ROM | 修復原因 |
|-----|---------:|
| apu_test/8-dmc_rates | DMC timer down-counter 正確處理速率切換 |
| apu_test/apu_test | 合併 ROM（因 test 8 通過而整體通過） |

---

*最後更新: 2026-02-22*
