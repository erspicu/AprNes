# BUGFIX22: AprNesLang.ini 缺失時程式掛掉 / 無提示

**日期**: 2026-02-26

## 問題

`AprNesLang.ini` 語系檔不在執行目錄時，程式有兩個潛在問題：

1. **`UpdateSoundMenuText()`** 沒有 guard，直接呼叫 `LangINI.lang_table[lang]["SoundON/OFF"]`，若語系檔不在（`LangLoadOK = false`）會拋出 `KeyNotFoundException` → **程式 crash**
2. **無任何使用者提示**：語系檔缺失時 UI 靜默 fallback，使用者不知道發生什麼事，所有按鈕顯示 Designer 預設英文文字

## 根因

### `UpdateSoundMenuText()` 無 guard（AprNesUI.cs）

```csharp
// 修改前 — 無 LangLoadOK 檢查，LangINI 未載入時直接 throw
void UpdateSoundMenuText()
{
    if (_soundMenuItem == null) return;
    _soundMenuItem.Text = NesCore.AudioEnabled
        ? LangINI.lang_table[AppConfigure["Lang"]]["SoundON"]
        : LangINI.lang_table[AppConfigure["Lang"]]["SoundOFF"];
}
```

`initUILang()` 和 `AprNes_ConfigureUI.SetLang()` 皆有 `if (!LangINI.LangLoadOK) return;`，但 `UpdateSoundMenuText()` 未同步加上此保護。

### `LangINI` 未記錄「檔案不在」狀態

原本 `LangLoadOK = false` 同時表示「尚未初始化」和「檔案不在」，無法在外部區分兩者，也無法對使用者顯示有意義的提示。

## 修復

### Fix 1: `LangINI.cs` — 新增 `LangFileMissing` flag 與安全取值 helper

```csharp
public static bool LangFileMissing = false;

// 安全取值：lang 不在、key 不在，一律回傳 fallback
public static string Get(string lang, string key, string fallback = "")
{
    if (!LangLoadOK) return fallback;
    if (!lang_table.ContainsKey(lang)) return fallback;
    string val;
    return lang_table[lang].TryGetValue(key, out val) ? val : fallback;
}

public static void init()
{
    if (LangLoadOK) return;
    if (!File.Exists(LangFile)) { LangFileMissing = true; return; }
    // ...
}
```

### Fix 2: `AprNesUI.cs` — 啟動時提示 + 修正 `UpdateSoundMenuText()`

```csharp
// 啟動時提示
LangINI.init();
if (LangINI.LangFileMissing)
    MessageBox.Show("AprNesLang.ini not found.\nUI will use default text.",
                    "Language file missing", MessageBoxButtons.OK, MessageBoxIcon.Warning);

// UpdateSoundMenuText — 加 guard + 用安全取值
void UpdateSoundMenuText()
{
    if (_soundMenuItem == null || !LangINI.LangLoadOK) return;
    string lang = AppConfigure["Lang"];
    _soundMenuItem.Text = NesCore.AudioEnabled
        ? LangINI.Get(lang, "SoundON",  "Sound ON")
        : LangINI.Get(lang, "SoundOFF", "Sound OFF");
}
```

## 改動檔案

| 檔案 | 改動 |
|------|------|
| `AprNes/tool/LangINI.cs` | 新增 `LangFileMissing` flag；新增 `Get(lang, key, fallback)` 安全取值 helper |
| `AprNes/UI/AprNesUI.cs` | 啟動後檢查 `LangFileMissing` 顯示 Warning；`UpdateSoundMenuText()` 加 guard 並改用 `LangINI.Get()` |

## 行為

| 情況 | 行為 |
|------|------|
| `AprNesLang.ini` 存在且正常 | 無變化，正常載入語系 |
| `AprNesLang.ini` 缺失 | 啟動時 Warning MessageBox，UI 保持 Designer 預設文字，不 crash |
| 語系檔存在但 key 缺失 | `LangINI.Get()` 回傳 fallback 字串，不 throw |
