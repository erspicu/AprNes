# BUGFIX21: TestRunner --pass-on-stable

**日期**: 2026-02-22
**基線**: 172 PASS / 2 FAIL → **174 PASS / 0 FAIL** (+2 PASS) — 全數通過！

## 問題

`read_joy3/count_errors` 和 `count_errors_fast` 成功時靜默退出（exit code 0），不印 "Passed" 文字。TestRunner 的 `--wait-result` 等待 "Passed"/"Failed" 文字，找不到就 timeout 報 FAIL。

**失敗測試**:
- `read_joy3/count_errors` — Timeout (no $6000 protocol, result=0xFF)
- `read_joy3/count_errors_fast` — 同上

## 根因

### blargg test framework 的 exit 機制

```
exit code 0 → 靜默退出（什麼都不印）
exit code 1 → 印 "Failed"
exit code ≥2 → 印 "Error N"
```

沒有 "exit code 0 → 印 Passed" 的機制。`tests_passed` 是獨立函式，不是自動呼叫。

### count_errors 的判斷邏輯

- 啟動 DMC 播放，呼叫 `read_joy`（4 次讀取投票演算法）1000 次
- `read_joy` 返回 0（無按鍵）= 正常 → 繼續
- `read_joy` 返回非 0 = 補償失敗 → `test_failed` → 印 "Failed"
- 主迴圈結束 → `rts` → exit code 0 → **靜默退出**

### count_errors_fast 的判斷邏輯

- 啟動 DMC 播放，呼叫 `read_joy_fast`（單次讀取，無補償）1000 次
- 計數錯誤次數，印 "Errors: N/1000"
- 永遠不印 "Passed" 或 "Failed"

## 修復

### Fix 1: TestRunner --pass-on-stable (TestRunner.cs)

新增 `--pass-on-stable` 參數。在 screen stability detection 中：
- 畫面穩定 + 有 "Failed" → **FAIL**
- 畫面穩定 + 無 "Failed" → **PASS**（因為測試成功時靜默退出，畫面不再變化）

```csharp
if (!earlyPass && !earlyFail && passOnStable)
{
    if (NametableContains("Failed") || NametableContains("FAILED"))
        earlyFail = true;
    else
        earlyPass = true;
}
```

### Fix 2: 測試腳本更新

`run_tests.sh` 和 `run_tests_report.sh` 為 count_errors/count_errors_fast 加入 `--pass-on-stable`。

## 改動檔案

| 檔案 | 改動 |
|------|------|
| `AprNes/TestRunner.cs` | +--pass-on-stable 參數和對應的 screen stability 判斷邏輯 |
| `run_tests.sh` | count_errors/count_errors_fast 加 --pass-on-stable |
| `run_tests_report.sh` | 同步 run_tests.sh |

## 測試結果

### 修復的測試 (+2 PASS)
| 測試 | 之前 | 之後 |
|------|------|------|
| count_errors | FAIL (timeout) | **PASS** (pass-on-stable) |
| count_errors_fast | FAIL (timeout) | **PASS** (pass-on-stable) |

### 回歸測試
**0 回歸** — 所有 172 個先前通過的測試仍然通過。

### 最終結果
**174 PASS / 0 FAIL / 174 TOTAL — 全數通過！**
