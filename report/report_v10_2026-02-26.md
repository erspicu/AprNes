# 2026-02-26 開發日誌（效能優化）

## 本次改動摘要

### 1. SRAM I/O 移出 NesCore

**目標**：NesCore 不再直接讀寫檔案系統，SRAM 存取由外部（UI 層）管理。

**做法**：
- `Main.cs`：
  - `battery` 欄位改為 `public bool HasBattery`
  - 移除 `rom_sav`、`SaveRam()` 及 `init()` 中的檔案 I/O
  - 新增 `LoadSRam(byte[] data)`（填入 `NES_MEM[0x6000..]`）與 `DumpSRam()`（傳回 byte[]）
  - 移除 `using System.IO`
- `AprNesUI.cs`：新增 `SaveSRam()` / `LoadSRam()` helpers，在 ROM 載入、HardReset、關閉時呼叫

---

### 2. XInput 雙 API 手把支援

**目標**：不使用第三方元件，直接 P/Invoke XInput API 支援 Xbox 控制器。

**做法**：
- `NativeAPIShare.cs`：新增 `XINPUT_GAMEPAD`、`XINPUT_STATE` struct 與 `XInputGetState` DllImport（`xinput1_4.dll`）
- `joystick.cs`：改寫為 WinMM + XInput 雙模式輪詢
  - XInput 裝置 ID = 1000 + player_index（避免與 WinMM 0–255 衝突）
  - D-Pad → X/Y 軸值 0/32767/65535，相容現有按鍵設定格式
  - 左類比搖桿支援死區（dead zone 8000）
  - DLL 不存在時自動 fallback 至僅 WinMM

---

### 3. `[AggressiveInlining]` 標記審計

審計 NesCore 全部方法，依呼叫頻率與大小標記：

| 檔案 | 新增 | 移除 |
|------|------|------|
| `APU.cs` | `setvolumes`、`apu_4000/01/02/04/05/06/08/09/0a/0c/0e/10/11/12/13`（16 個） | — |
| `PPU.cs` | `CXinc`、`CopyHoriV`、`ppu_w_2001/2003/2004`、`ppu_r_2004`（6 個） | `ppu_step_new`（過大） |
| `CPU.cs` | — | `cpu_step`（過大） |
| `JoyPad.cs` | `P1_ButtonPress`、`P1_ButtonUnPress`（2 個） | — |

合計 NesCore 全域 AggressiveInlining 方法：39 個。

---

### 4. APU.cs 1D managed array → unsafe int\* / byte\* 指標

**目標**：消除 APU 熱路徑上的 managed array bounds-check overhead。

**做法**：
- 新增 `using System.Runtime.InteropServices`
- `NesCore` class 宣告改為 `unsafe partial class`（PPU.cs 原本就是）
- 21 個 `int[]` 欄位 → `int*`，使用 `Marshal.AllocHGlobal` 分配
- 9 個 `bool[]` 欄位 → `byte*`（0=false, 1=true）
- `initSquareLookup()` / `initTndLookup()` helper 函式移除，計算邏輯 inline 進 `initAPU()`
- `SQUARELOOKUP.Length` → 常數 `31`；`TNDLOOKUP.Length` → 常數 `203`
- Null-check 模式：`if (xxx == null) xxx = (int*)Marshal.AllocHGlobal(...)` 防止重複分配

**保留不動**：
- `int[,] DUTYLOOKUP`（2D array）
- `int[] TRI_SEQ`（小型唯讀表，邊界存取不影響熱路徑）

**轉換清單**：

| 原型別 | 欄位 | 大小 |
|--------|------|------|
| `int[]` | `_pulseTimer/Period/Seq/Duty/Out` | 各 2 |
| `int[]` | `volume` | 4 |
| `int[]` | `lengthctr`, `lengthctr_snapshot`, `lenctrload` | 4, 4, 32 |
| `int[]` | `envelopeValue/Counter/Pos` | 各 4 |
| `int[]` | `sweepperiod/shift/pos` | 各 2 |
| `int[]` | `noiseperiod`, `dmcperiods` | 各 16 |
| `int[]` | `frameReload4/5` | 4, 5 |
| `int[]` | `SQUARELOOKUP`, `TNDLOOKUP` | 31, 203 |
| `bool[]` | `lenCtrEnable`, `lengthClockThisCycle`, `lenctrHalt` | 各 4 |
| `bool[]` | `envConstVolume`, `envelopeStartFlag` | 各 4 |
| `bool[]` | `sweepenable/negate/silence/reload` | 各 2 |

---

### 5. PPU NesColorsData / defaultPal managed array 移除

**目標**：移除 PPU.cs 中剩餘的兩個 `static readonly` managed array。

**原狀況**：
- `static readonly uint[] NesColorsData` (64 entries) → 啟動時 copy 進 `NesColors`（`uint*`）
- `static readonly byte[] defaultPal` (32 entries) → 啟動時 copy 進 `ppu_ram[0x3F00..]`（`byte*`）

**做法**：
- 移除兩個 managed array 宣告
- 新增 `static void initPalette()` 方法，直接對 `NesColors`（`uint*`）與 `ppu_ram[0x3F00..]`（`byte*`）逐一賦值
- `Main.cs init()` 改呼叫 `initPalette()`，移除原本兩個 for loop

---

### 驗證結果

| 指標 | 狀態 |
|------|------|
| Debug x64 build 成功，無 error/warning | ✅ |
| NesCore 無 `static readonly ... []` managed array（熱路徑上） | ✅ |
| APU 全部 1D array 改為 `Marshal.AllocHGlobal` 指標 | ✅ |
| PPU NesColorsData / defaultPal 移除 | ✅ |
| XInput + WinMM 雙模式手把正常偵測 | ✅ |

---

## Git 記錄

| commit | 說明 |
|--------|------|
| （SRAM）| refactor: move SRAM file I/O out of NesCore |
| （XInput）| feat: add XInput dual-API joystick support |
| （Inline）| perf: apply AggressiveInlining to NesCore hot methods |
| 4b34a3b | perf: convert APU.cs 1D managed arrays to unsafe int*/byte* pointers |
| e0f9672 | perf: remove NesColorsData/defaultPal managed arrays, inline into initPalette() |
