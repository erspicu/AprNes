# AprNes Test Report v4

- Date: 2026-02-20 20:30 (UTC+8)
- Build: Debug (MSBuild 14.0 / .NET Framework 4.6.1)
- Test Runner: Console headless mode (`--wait-result --max-wait 30`)
- ROM Source: `nes-test-roms-master/checked/`
- Merged ROM timeout: `--max-wait 120`

## Summary: 120 PASS / 34 FAIL (154 ROMs)

### Changes since v3 (2026-02-20 19:50)

| Item | Description |
|---|---|
| New test suites | apu_mixer, apu_reset, apu_test, blargg_apu_2005.07.30 |

> v3 had 105 PASS / 19 FAIL (124 ROMs). v4 adds 30 new APU ROMs (15 PASS / 15 FAIL). All previously-passing tests remain passing.

---

## Test Suite Results

| Test Suite | Pass | Total | Status |
|---|---|---|---|
| apu_mixer | 4 | 4 | PASS |
| apu_reset | 0 | 6 | 6 FAIL |
| apu_test | 0 | 9 | 9 FAIL |
| blargg_apu_2005.07.30 | 11 | 11 | PASS |
| blargg_nes_cpu_test5 | 2 | 2 | PASS |
| blargg_ppu_tests_2005 | 5 | 5 | PASS |
| branch_timing_tests | 3 | 3 | PASS |
| cpu_dummy_reads | 1 | 1 | PASS |
| cpu_dummy_writes | 2 | 2 | PASS |
| cpu_exec_space | 1 | 2 | 1 FAIL |
| cpu_interrupts_v2 | 4 | 6 | 2 FAIL |
| cpu_reset | 2 | 2 | PASS |
| cpu_timing_test6 | 1 | 1 | PASS |
| dmc_dma_during_read4 | 5 | 5 | PASS |
| instr_misc | 2 | 5 | 3 FAIL |
| instr_test-v3 | 17 | 17 | PASS |
| instr_test-v5 | 18 | 18 | PASS |
| instr_timing | 1 | 3 | 2 FAIL |
| nes_instr_test | 11 | 11 | PASS |
| oam_read | 1 | 1 | PASS |
| ppu_open_bus | 1 | 1 | PASS |
| ppu_read_buffer | 0 | 1 | 1 FAIL |
| ppu_vbl_nmi | 3 | 10 | 7 FAIL |
| read_joy3 | 4 | 4 | PASS |
| sprdma_and_dmc_dma | 0 | 2 | 2 FAIL |
| sprite_hit_tests | 11 | 11 | PASS |
| sprite_overflow_tests | 5 | 5 | PASS |
| vbl_nmi_timing | 7 | 7 | PASS |

---

## Fully Passing Suites (19/28)

### apu_mixer (4/4) -- NEW
- dmc.nes, noise.nes, square.nes, triangle.nes

### blargg_apu_2005.07.30 (11/11) -- NEW
- 01.len_ctr.nes ~ 11.len_reload_timing.nes

### blargg_nes_cpu_test5 (2/2)
- cpu.nes, official.nes

### blargg_ppu_tests_2005 (5/5)
- palette_ram.nes, power_up_palette.nes, sprite_ram.nes, vbl_clear_time.nes, vram_access.nes

### branch_timing_tests (3/3)
- 1.Branch_Basics.nes, 2.Backward_Branch.nes, 3.Forward_Branch.nes

### cpu_dummy_reads (1/1)
- cpu_dummy_reads.nes

### cpu_dummy_writes (2/2)
- cpu_dummy_writes_oam.nes, cpu_dummy_writes_ppumem.nes

### cpu_reset (2/2)
- registers.nes, ram_after_reset.nes

### cpu_timing_test6 (1/1)
- cpu_timing_test.nes

### dmc_dma_during_read4 (5/5)
- dma_2007_read.nes, dma_2007_write.nes, dma_4016_read.nes, double_2007_read.nes, read_write_2007.nes

### instr_test-v3 (17/17)
- all_instrs.nes, official_only.nes, rom_singles 01~15

### instr_test-v5 (18/18)
- all_instrs.nes, official_only.nes, rom_singles 01~16

### nes_instr_test (11/11)
- rom_singles 01~11

### oam_read (1/1)
- oam_read.nes

### ppu_open_bus (1/1)
- ppu_open_bus.nes

### read_joy3 (4/4)
- test_buttons.nes, count_errors.nes, count_errors_fast.nes, thorough_test.nes

### sprite_hit_tests (11/11)
- 01.basics ~ 11.edge_timing

### sprite_overflow_tests (5/5)
- 1.Basics ~ 5.Emulator

### vbl_nmi_timing (7/7)
- 1.frame_basics ~ 7.nmi_timing

---

## Failure Details (34 ROMs)

### Category 1: PPU VBL/NMI Sub-Scanline Timing (7)

| ROM | Error |
|---|---|
| ppu_vbl_nmi.nes | Merged ROM, fails at test 2/10 (vbl_set_time) |
| 02-vbl_set_time.nes | VBL flag set timing off by 1 PPU cycle |
| 03-vbl_clear_time.nes | VBL flag clear timing inaccurate |
| 04-nmi_control.nes | "Immediate occurence should be after NEXT instruction" (#11) |
| 06-suppression.nes | VBL read suppression timing incorrect |
| 07-nmi_on_timing.nes | NMI enable timing off |
| 08-nmi_off_timing.nes | NMI disable timing off |

> Root cause: PPU VBL flag set/clear and NMI enable/disable timing at sub-scanline level need cycle-accurate CPU/PPU synchronization.

### Category 2: CPU Dummy Read / PPU Interaction (5)

| ROM | Error | Notes |
|---|---|---|
| cpu_exec_space/test_cpu_exec_space_apu.nes | FAIL(2) | Needs CPU fetch via IO_read |
| instr_misc/instr_misc.nes | FAIL(128) — merged ROM timeout | Official opcodes pass; stuck on unofficial |
| instr_misc/03-dummy_reads.nes | FAIL(4) — "STA abs,x" | PPU side-effect issue |
| instr_misc/04-dummy_reads_apu.nes | FAIL(2) — unofficial opcodes only | **All official opcodes pass** |
| ppu_vbl_nmi/10-even_odd_timing.nes | FAIL(3) — "Clock is skipped too late" | Needs cycle-accurate sync |

### Category 3: CPU Interrupt + DMA Interaction (3)

| ROM | Error |
|---|---|
| cpu_interrupts_v2/cpu_interrupts.nes | Merged ROM, fails at test 4/5 (irq_and_dma) |
| cpu_interrupts_v2/4-irq_and_dma.nes | IRQ + OAM DMA cycle precision |
| cpu_interrupts_v2/5-branch_delays_irq.nes | Branch instruction delays IRQ cycle count |

### Category 4: Instruction Timing -- Illegal Opcodes (2)

| ROM | Error |
|---|---|
| instr_timing/instr_timing.nes | FAIL(1) — unofficial instruction timing |
| instr_timing/1-instr_timing.nes | FAIL(4) — 8B/93/9B/9F/BB timing=0 |

### Category 5: DMA Cycle Accuracy (2)

| ROM | Error |
|---|---|
| sprdma_and_dmc_dma.nes | FAIL(1) — OAM+DMC DMA cycle conflict, all show 399 |
| sprdma_and_dmc_dma_512.nes | FAIL(1) — same |

### Category 6: PPU Read Buffer + DMA (1)

| ROM | Error |
|---|---|
| test_ppu_read_buffer.nes | FAIL(54) — 4 sub-tests failed (#54, #65, #67, #69) |

### Category 7: APU Reset State (6) -- NEW

| ROM | Error |
|---|---|
| 4015_cleared.nes | FAIL(2) — "At power, $4015 should be cleared" |
| 4017_timing.nes | FAIL(3) — "Frame IRQ flag should be set sooner after power/reset" |
| 4017_written.nes | FAIL(2) — "At power, $4017 should be written with $00" |
| irq_flag_cleared.nes | FAIL(3) — "At reset, flag should be clear" |
| len_ctrs_enabled.nes | FAIL(2) — "At power, length counters should be enabled" |
| works_immediately.nes | FAIL(2) — "At power, writes should work immediately" |

> Root cause: APU `init()` 不正確設定初始狀態。$4015 在 power-on 時應為 $00（所有聲道 disabled），$4017 應以 $00 寫入（mode 0）。目前 `initAPU()` 未正確初始化 frame counter 狀態和 $4015/$4017 暫存器。

### Category 8: APU Frame Counter / Length Counter / IRQ / DMC (9) -- NEW

| ROM | Error |
|---|---|
| apu_test.nes | FAIL(1) — merged ROM, fails test 1 (len_ctr) #4 |
| 1-len_ctr.nes | FAIL(4) — "Writing $80 to $4017 should clock length immediately" |
| 2-len_table.nes | FAIL(1) — length table values incorrect |
| 3-irq_flag.nes | FAIL(7) — "Writing $40 or $C0 to $4017 should clear flag" |
| 4-jitter.nes | FAIL(5) — "Odd jitter not handled properly" |
| 5-len_timing.nes | FAIL(3) — "First length of mode 0 is too late" |
| 6-irq_flag_timing.nes | FAIL(2) — "Flag first set too soon" |
| 7-dmc_basics.nes | FAIL(12) — "Disabling IRQ flag should clear it" |
| 8-dmc_rates.nes | FAIL(3) — "Rate 0's period is too long" |

> Root cause: APU frame counter 實作缺少以下功能：
> - $4017 寫入 $80 時應立即 clock length counter（mode 1 立即觸發 half-frame）
> - Length table 值不正確
> - $4017 寫入 $40/$C0 應清除 frame IRQ flag
> - APU clock jitter（奇偶 cycle 延遲）未處理
> - Frame counter mode 0 的 length clock timing 偏晚
> - Frame IRQ flag 設定時機偏早
> - DMC IRQ flag 在 disable 時應被清除
> - DMC rate 0 的 period 不正確

---

## Future Fix Priorities

| Priority | Item | Failing ROMs | Difficulty | Notes |
|---|---|---|---|---|
| 1 | APU init state ($4015/$4017) | 6 | Low-Medium | apu_reset 全部 |
| 2 | APU frame counter timing | 9 | Medium-High | length clock, IRQ flag, jitter |
| 3 | APU length table | 1 | Low | 查表值修正 |
| 4 | DMC IRQ / rates | 2 | Medium | IRQ clear + rate period |
| 5 | Unofficial opcode timing | 2 | Medium | ~20 unimplemented illegal opcodes |
| 6 | CPU fetch via IO_read | 1 | Medium | cpu_exec_space_apu |
| 7 | PPU $3000-$3EFE mirror | 1 | Low | ppu_read_buffer #54 |
| 8 | OAM DMA + DMC DMA interleave | 2 | High | sprdma_and_dmc_dma |
| 9 | IRQ + DMA interaction timing | 3 | High | Cycle-accurate OAM DMA |
| 10 | PPU sub-cycle VBL/NMI | 8 | Very High | Cycle-accurate CPU/PPU sync |

---

## Test Configuration Notes

- **cpu_reset**: Uses auto-detect `$6000==$81` protocol (no explicit `--soft-reset`)
- **apu_reset/irq_flag_cleared.nes**: Uses auto-detect `$6000==$81` protocol for soft reset
- **read_joy3/test_buttons.nes**: Requires `--input "Start:2.0,A:4.0,B:6.0,Select:8.0,Up:10.0,Down:12.0,Left:14.0,Right:16.0"` and `--max-wait 60`
- **Merged ROMs**: Use `--max-wait 120`

## File Index

| File | Description |
|---|---|
| `report/results_full.log` | Full test output log (this run) |
| `report/screenshots/` | Screenshots for all 154 test ROMs |
| `report/report_v3_2026-02-20.md` | Previous report (v3, 105/19, 124 ROMs) |
| `report/report_v2_2026-02-20.md` | Previous report (v2, 95/17, 112 ROMs) |
