# AprNes 測試報告 v7

- 日期: 2026-02-22 (UTC+8)
- 編譯: Debug (MSBuild 14.0 / .NET 4.6.1)
- 測試方式: Console headless mode (`--wait-result --max-wait 30`)
- ROM 來源: `nes-test-roms-master/checked/`
- 合併 ROM 逾時: `--max-wait 120`

## 總結: 171 PASS / 3 FAIL (174 ROMs)

### 自 v6 以來的變更 (+46 PASS)

| BUGFIX | 說明 | 新增 PASS |
|--------|------|----------|
| BUGFIX9 | APU frame counter timing (frameReload, $4017 offset, jitter, IRQ assert) | +6 |
| BUGFIX10 | DMC timer down-counter, rate switch timing | +2 |
| BUGFIX11 | APU $4017 reset/power-on advance, length reload suppression | +3 |
| BUGFIX12 | PPU VBL/NMI 1-cycle delay model, per-dot edge detection | +15 |
| BUGFIX13 | MMC3 scanline timing (BG/sprite A12 phase, garbage NT, VBL gap) | +2 |
| BUGFIX14 | APU IRQ timing (framectrdiv compensation, irqAssertCycles, lengthctr_snapshot) | +3 |
| BUGFIX14 bonus | Branch IRQ suppression, OAM DMA IRQ deferral, 3-nmi_and_irq | +1 |
| BUGFIX15 | 手把測試腳本修正 | +1 |
| BUGFIX16 | MMC3 scanline timing v2 (PPU A12 phase alignment) | +2 |
| BUGFIX17 | Sprite timing (per-pixel hit, cycle-accurate overflow, hw overflow bug) | +4 |
| BUGFIX18 | CPU interrupt timing (irqLinePrev/Current, NMI deferral, DMA alignment) | +4 |
| BUGFIX19 | DMC DMA cycle stealing (Load/Reload model, phantom reads, CRC detection) | +2 |

> 基線 (v6): 125 PASS / 49 FAIL / 174 ROMs
> 本次 (v7): 171 PASS / 3 FAIL / 174 ROMs (+46 PASS, 0 退化)

---

## 各測試套件結果

| 測試套件 | 通過 | 總計 | 狀態 |
|----------|------|------|------|
| apu_mixer | 4 | 4 | ✅ ALL PASS |
| apu_reset | 6 | 6 | ✅ ALL PASS |
| apu_test | 9 | 9 | ✅ ALL PASS |
| blargg_apu_2005.07.30 | 11 | 11 | ✅ ALL PASS |
| blargg_nes_cpu_test5 | 2 | 2 | ✅ ALL PASS |
| blargg_ppu_tests_2005 | 5 | 5 | ✅ ALL PASS |
| branch_timing_tests | 3 | 3 | ✅ ALL PASS |
| cpu_dummy_reads | 1 | 1 | ✅ ALL PASS |
| cpu_dummy_writes | 2 | 2 | ✅ ALL PASS |
| cpu_exec_space | 2 | 2 | ✅ ALL PASS |
| cpu_interrupts_v2 | 6 | 6 | ✅ ALL PASS |
| cpu_reset | 2 | 2 | ✅ ALL PASS |
| cpu_timing_test6 | 1 | 1 | ✅ ALL PASS |
| dmc_dma_during_read4 | 4 | 5 | 1 FAIL |
| instr_misc | 5 | 5 | ✅ ALL PASS |
| instr_test-v3 | 17 | 17 | ✅ ALL PASS |
| instr_test-v5 | 18 | 18 | ✅ ALL PASS |
| instr_timing | 3 | 3 | ✅ ALL PASS |
| mmc3_irq_tests | 6 | 6 | ✅ ALL PASS |
| mmc3_test | 6 | 6 | ✅ ALL PASS |
| mmc3_test_2 | 6 | 6 | ✅ ALL PASS |
| nes_instr_test | 11 | 11 | ✅ ALL PASS |
| oam_read | 1 | 1 | ✅ ALL PASS |
| ppu_open_bus | 1 | 1 | ✅ ALL PASS |
| ppu_read_buffer | 1 | 1 | ✅ ALL PASS |
| ppu_vbl_nmi | 11 | 11 | ✅ ALL PASS |
| read_joy3 | 2 | 4 | 2 FAIL |
| sprdma_and_dmc_dma | 2 | 2 | ✅ ALL PASS |
| sprite_hit_tests | 11 | 11 | ✅ ALL PASS |
| sprite_overflow_tests | 5 | 5 | ✅ ALL PASS |
| vbl_nmi_timing | 7 | 7 | ✅ ALL PASS |

**28/31 套件全數通過**，僅 3 套件有殘餘失敗。

---

## 失敗詳情 (3 ROMs)

### Bug I: PPU $2007 data buffer latching delay (1)

| ROM | 原因 |
|-----|------|
| dmc_dma_during_read4/double_2007_read | Page-crossing dummy read to $2007 立即更新 buffer，真實 NES 有延遲。CRC D84F6815（期望 85CFD627/F018C287/440EF923/E52F41A5） |

### Bug H 剩餘: 手把讀取精確度 (2)

| ROM | 原因 |
|-----|------|
| read_joy3/count_errors | 手把 DPCM-interference bit counting |
| read_joy3/count_errors_fast | 同上（快速版） |

---

## 修復歷程 (v6→v7)

```
v6 基線: 125 PASS / 49 FAIL

BUGFIX9  (APU frame counter)         → 131 PASS (+6)
BUGFIX10 (DMC timer)                 → 133 PASS (+2)  [*新增於此版]
BUGFIX11 (APU reset/power-on)        → 136 PASS (+3)  [*新增於此版]
BUGFIX12 (PPU VBL/NMI timing)        → 151 PASS (+15) ★
BUGFIX13 (MMC3 scanline timing)      → 153 PASS (+2)
BUGFIX14 (APU IRQ + CPU interrupt)   → 158 PASS (+5)  ★★
BUGFIX15 (手把測試修正)              → 159 PASS (+1)
BUGFIX16 (MMC3 scanline v2)          → 161 PASS (+2)
BUGFIX17 (Sprite timing)             → 165 PASS (+4)  ★★
BUGFIX18 (CPU interrupt timing)      → 169 PASS (+4)  ★★★
BUGFIX19 (DMC DMA cycle stealing)    → 171 PASS (+2)  ★★★★

v7 最終: 171 PASS / 3 FAIL (+46 PASS, 0 退化)
```

---

## 技術亮點

### BUGFIX19: DMC DMA Cycle Stealing
本次最具挑戰性的修復。原本在 TODO.md 中標記為「需架構重構」的問題，透過以下設計避免了大規模重構：

- **dmc_stolen_tick()**: PPU-only tick 函式，僅推進 PPU 3 dots + NMI/IRQ tracking，不呼叫 apu_step() 避免遞迴
- **Load/Reload 模型**: 根據 NESdev Wiki DMA 參考，區分 $4015 write 觸發的 Load DMA（3 cycles）和 buffer 耗盡的 Reload DMA（4 cycles），以及 write-delay 反轉規則
- **Phantom reads**: 模擬 DMC halt 期間 CPU bus 上的重複讀取，$4016/$4017 僅在 halt cycle 觸發（NES-001 /OE 行為）
- **--expected-crc**: TestRunner 新增 CRC 比對機制，支援多個有效 CRC 的測試（因 CPU-PPU 同步隨機性）

### 全套件通過里程碑
以下套件從 v6 的部分失敗達到 v7 的全數通過：
- **ppu_vbl_nmi**: 3/11 → 11/11 (BUGFIX12)
- **vbl_nmi_timing**: 1/7 → 7/7 (BUGFIX12)
- **blargg_apu_2005**: 3/11 → 11/11 (BUGFIX9/11/14)
- **cpu_interrupts_v2**: 1/6 → 6/6 (BUGFIX14/18)
- **mmc3_irq_tests**: 5/6 → 6/6 (BUGFIX16)
- **mmc3_test**: 4/6 → 6/6 (BUGFIX13/16)
- **mmc3_test_2**: 4/6 → 6/6 (BUGFIX13/16)
- **sprite_hit_tests**: 9/11 → 11/11 (BUGFIX17)
- **sprite_overflow_tests**: 3/5 → 5/5 (BUGFIX17)
- **sprdma_and_dmc_dma**: 0/2 → 2/2 (BUGFIX19)

---

## 檔案索引

| 檔案 | 說明 |
|------|------|
| `report/results.json` | 完整測試結果 (JSON) |
| `report/index.html` | HTML 測試報告 (含截圖) |
| `report/methodology.html` | 測試方法論 (英文) |
| `report/methodology_zh.html` | 測試方法論 (中文) |
| `bugfix/2026-02-22_BUGFIX19.md` | 最新 Bug 修復紀錄 |
| `report/report_v6_2026-02-21.md` | 上一份報告 (v6, 125 PASS / 49 FAIL) |
