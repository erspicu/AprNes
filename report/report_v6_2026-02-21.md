# AprNes 測試報告 v6

- 日期: 2026-02-21 12:00 (UTC+8)
- 編譯: Debug (MSBuild 14.0 / .NET 4.6.1)
- 測試方式: Console headless mode (`--wait-result --max-wait 30`)
- ROM 來源: `nes-test-roms-master/checked/`
- 合併 ROM 逾時: `--max-wait 120`

## 總結: 125 PASS / 49 FAIL (174 ROMs)

### 自 v5 以來的變更

| 項目 | 說明 |
|------|------|
| BUGFIX5-7 (v5→baseline) | CPU dummy reads, new opcodes, MMC3 flag-based IRQ polling 等 |
| **BUGFIX8: MMC3 A12 clocking** | **IRQ counter 改為 PPU A12 rising edge 驅動（本次）** |

> 基線: 113 PASS / 61 FAIL / 174 ROMs (含 18 個新增 MMC3 測試)
> 本次: 125 PASS / 49 FAIL / 174 ROMs (+12 PASS, 0 退化)

---

## 各測試套件結果

| 測試套件 | 通過 | 總計 | 狀態 |
|----------|------|------|------|
| apu_mixer | 4 | 4 | PASS |
| apu_reset | 5 | 6 | 1 FAIL |
| apu_test | 4 | 9 | 5 FAIL |
| blargg_apu_2005.07.30 | 3 | 11 | 8 FAIL |
| blargg_nes_cpu_test5 | 2 | 2 | PASS |
| blargg_ppu_tests_2005 | 5 | 5 | PASS |
| branch_timing_tests | 3 | 3 | PASS |
| cpu_dummy_reads | 1 | 1 | PASS |
| cpu_dummy_writes | 2 | 2 | PASS |
| cpu_exec_space | 2 | 2 | PASS |
| cpu_interrupts_v2 | 1 | 6 | 5 FAIL |
| cpu_reset | 2 | 2 | PASS |
| cpu_timing_test6 | 1 | 1 | PASS |
| dmc_dma_during_read4 | 2 | 5 | 3 FAIL |
| instr_misc | 4 | 5 | 1 FAIL |
| instr_test-v3 | 17 | 17 | PASS |
| instr_test-v5 | 18 | 18 | PASS |
| instr_timing | 3 | 3 | PASS |
| **mmc3_irq_tests** | **5** | **6** | **1 FAIL** |
| **mmc3_test** | **4** | **6** | **2 FAIL** |
| **mmc3_test_2** | **4** | **6** | **2 FAIL** |
| nes_instr_test | 11 | 11 | PASS |
| oam_read | 1 | 1 | PASS |
| ppu_open_bus | 1 | 1 | PASS |
| ppu_read_buffer | 1 | 1 | PASS |
| ppu_vbl_nmi | 3 | 11 | 8 FAIL |
| read_joy3 | 3 | 4 | 1 FAIL |
| sprdma_and_dmc_dma | 0 | 2 | 2 FAIL |
| sprite_hit_tests | 9 | 11 | 2 FAIL |
| sprite_overflow_tests | 3 | 5 | 2 FAIL |
| vbl_nmi_timing | 1 | 7 | 6 FAIL |

---

## 本次新通過的 ROM (12 個)

全部為 MMC3 A12 clocking 修復：

| ROM | 修復原因 |
|-----|---------|
| mmc3_irq_tests/1.Clocking | A12 rising edge 驅動 IRQ counter |
| mmc3_irq_tests/2.Details | counter reload/decrement 正確 |
| mmc3_irq_tests/3.A12_clocking | $2006 手動 A12 toggle clock counter |
| mmc3_irq_tests/6.MMC3_rev_B | Rev B reload 行為正確 |
| mmc3_test/1-clocking | A12 驅動 clocking |
| mmc3_test/2-details | counter 細節正確 |
| mmc3_test/3-A12_clocking | $2006 A12 clocking |
| mmc3_test/5-MMC3 | MMC3 整體行為 |
| mmc3_test_2/1-clocking | 同上系列 |
| mmc3_test_2/2-details | 同上 |
| mmc3_test_2/3-A12_clocking | 同上 |
| mmc3_test_2/5-MMC3 | 同上 |

---

## 失敗詳情 (49 ROMs)

### 分類 1: MMC3 殘餘 (5)

| ROM | 原因 |
|-----|------|
| mmc3_irq_tests/5.MMC3_rev_A | 我們實作 Rev B，Rev A 行為不同 |
| mmc3_test/4-scanline_timing | sprite fetch A12 timing 需精進 |
| mmc3_test/6-MMC6 | MMC6 不同晶片，需獨立實作 |
| mmc3_test_2/4-scanline_timing | 同 mmc3_test/4 |
| mmc3_test_2/6-MMC3_alt | MMC3 alternate 行為 (可能 Rev A) |

### 分類 2: PPU VBL/NMI timing (14)

| ROM | 錯誤訊息 |
|-----|---------|
| ppu_vbl_nmi/ppu_vbl_nmi | 合併 ROM, test 2/10 失敗 |
| 02-vbl_set_time | VBL flag 設定時序差 1 PPU cycle |
| 04-nmi_control | "Immediate occurrence should be after NEXT instruction" |
| 05-nmi_timing | NMI timing 偏差 |
| 06-suppression | VBL 讀取抑制時序 |
| 07-nmi_on_timing | NMI 啟用時序偏差 |
| 08-nmi_off_timing | NMI 停用時序偏差 |
| 10-even_odd_timing | "Clock is skipped too late" |
| vbl_nmi_timing/2.vbl_timing | VBL timing |
| vbl_nmi_timing/3.even_odd_frames | even/odd frame toggle |
| vbl_nmi_timing/4.vbl_clear_timing | VBL clear timing |
| vbl_nmi_timing/5.nmi_suppression | NMI suppression |
| vbl_nmi_timing/6.nmi_disable | NMI disable |
| vbl_nmi_timing/7.nmi_timing | NMI timing |

### 分類 3: APU timing (14)

| ROM | 錯誤訊息 |
|-----|---------|
| apu_reset/4017_written | "$4017 should be rewritten with last value" |
| apu_test/apu_test | 合併 ROM (4/5/6/8 失敗) |
| apu_test/4-jitter | "Frame IRQ is set too late" |
| apu_test/5-len_timing | "First length of mode 0 is too late" |
| apu_test/6-irq_flag_timing | "Flag first set too late" |
| apu_test/8-dmc_rates | "Rate 0's period is too long" |
| blargg_apu/04.clock_jitter | clock jitter |
| blargg_apu/05.len_timing_mode0 | length timing mode 0 |
| blargg_apu/06.len_timing_mode1 | length timing mode 1 |
| blargg_apu/07.irq_flag_timing | IRQ flag timing |
| blargg_apu/08.irq_timing | IRQ timing |
| blargg_apu/09.reset_timing | reset timing |
| blargg_apu/10.len_halt_timing | length halt timing |
| blargg_apu/11.len_reload_timing | length reload timing |

### 分類 4: CPU interrupt timing (5)

| ROM | 錯誤訊息 |
|-----|---------|
| cpu_interrupts_v2/cpu_interrupts | 合併 ROM |
| 2-nmi_and_brk | NMI 與 BRK 交互 |
| 3-nmi_and_irq | NMI 與 IRQ 交互 |
| 4-irq_and_dma | IRQ + OAM DMA cycle 精度 |
| 5-branch_delays_irq | branch 延遲 IRQ |

### 分類 5: DMC DMA (5)

| ROM | 錯誤訊息 |
|-----|---------|
| dmc_dma/dma_2007_read | DMC DMA 與 $2007 讀取 |
| dmc_dma/dma_4016_read | DMC DMA 與 $4016 讀取 |
| dmc_dma/double_2007_read | 雙重 $2007 讀取 |
| sprdma_and_dmc_dma | OAM+DMC DMA cycle 衝突 |
| sprdma_and_dmc_dma_512 | 同上 512 byte |

### 分類 6: Sprite timing (4)

| ROM | 錯誤訊息 |
|-----|---------|
| sprite_hit/09.timing_basics | sprite hit timing |
| sprite_hit/10.timing_order | sprite hit timing order |
| sprite_overflow/3.Timing | sprite overflow timing |
| sprite_overflow/4.Obscure | sprite overflow obscure |

### 分類 7: 其他 (2)

| ROM | 錯誤訊息 |
|-----|---------|
| instr_misc/instr_misc | 合併 ROM 逾時 (singles 全 PASS) |
| read_joy3/thorough_test | 搖桿讀取 timing |

---

## 未來修復優先順序

| 優先級 | 項目 | 影響 ROM 數 | 難度 |
|--------|------|-----------|------|
| 1 | PPU VBL/NMI sub-cycle timing | 14 | 高 |
| 2 | APU frame counter 精確 timing | 14 | 中高 |
| 3 | CPU interrupt timing (NMI/IRQ/BRK) | 5 | 高 |
| 4 | DMC DMA cycle stealing | 5 | 高 |
| 5 | MMC3 scanline timing 精進 | 3 | 中 |
| 6 | Sprite timing 精度 | 4 | 中高 |

---

## 檔案索引

| 檔案 | 說明 |
|------|------|
| `report/results.json` | 完整測試結果 (JSON) |
| `report/index.html` | HTML 測試報告 (含截圖) |
| `bugfix/2026-02-21_BUGFIX8.md` | 本次 Bug 修復紀錄 |
| `report/report_v5_2026-02-20.md` | 上一份報告 (v5, 130/26, 156 ROMs) |
