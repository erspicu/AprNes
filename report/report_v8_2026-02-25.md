# 2026-02-25 開發日誌

## 本次改動摘要

### 1. .github/copilot-instructions.md — 新增 Copilot 工作指引

建立 `.github/copilot-instructions.md`，包含：
- 建置指令（build.ps1 / MSBuild）
- 測試指令（單 ROM、全套件、HTML 報告）
- 架構說明（partial class、tick model、memory dispatch、mapper、APU）
- 關鍵慣例（static-only、unsafe、繁體中文溝通、web 下載用 page_getter）

---

### 2. 鍵盤多鍵同壓問題調查 → 確認非模擬器問題

**現象**：SMB3 中 Z+X+→ 無法同時觸發，但 Z+X+← 可以。

**調查過程**：
- 分析鍵盤輸入鏈（ProcessCmdKey → NES_KeyMAP → P1_ButtonPress）
- 嘗試改為 GetAsyncKeyState 每幀輪詢
- 建立 `KeyTest/KeyTest.exe` 直接用 GetAsyncKeyState 測試

**結論**：GetAsyncKeyState 同樣無法偵測 Z+X+→，確認為**硬體鍵盤 Matrix Ghosting**，與模擬器無關。還原為原始 event-driven 實作。

**文件**：`bugfix/2026-02-25_KEYBOARD_GHOSTING.md`

---

### 3. FPS 限制精確性改善（PPU.cs / Main.cs）

**問題**：
1. 目標時間 `0.016s` = 60.0 Hz，NES NTSC 正確為 60.0988 Hz
2. `Thread.Sleep(1)` 最後一次過衝，每幀 ±1ms 誤差
3. 每幀獨立計時（StopWatch.Restart），無累積誤差補償

**修正**：
- 目標改為 `1.0 / 60.0988 ≈ 0.016639s`
- Hybrid sleep：距 deadline >1ms 用 Sleep(1)，最後 <1ms 改 spin-wait
- `_fpsDeadline` 累積推進，自動補償單幀偏差

精度：±1ms → <0.1ms

---

### 4. FPS 統計顯示改善（PPU.cs / AprNesUI.cs）

**問題**：
- `frame_count` 非 `volatile`，JIT 可能讀到舊值
- 讀+清零非原子操作，有 race condition
- WinForms Timer 不保證精確 1000ms，分母有誤差
- 整數顯示無法分辨細微差異

**修正**：
- `frame_count` 加 `volatile`
- 改用 `Interlocked.Exchange` 原子讀取+清零
- 用 `Stopwatch` 量實際 tick 間隔當分母
- 顯示改為一位小數（e.g. `fps : 60.1`）

---

### 5. 移除編譯警告（APU.cs）

| 警告 | 修法 |
|------|------|
| CS0414 `dmcReloadPending` | 欄位只有賦值從不讀取，整個移除 |
| CS0168 `catch (Exception ex)` | ex 未使用，改為 `catch (Exception)` |

---

### 6. 音效音量設定 UI（APU.cs / AprNesUI.cs / AprNes_ConfigureUI.cs）

新增音量控制功能：

- `APU.cs`：新增 `Volume` 欄位（0~100，預設 70），輸出樣本乘以 `Volume/100`
- `AprNesUI.cs`：LoadConfig 讀 Volume、Configure_Write 寫 Volume、ini 預設加 `Volume=70`
- `AprNes_ConfigureUI.cs`：
  - Shown：從 NesCore 載入狀態至 UI
  - `UpdateSoundUI()`：TrackBar.Enabled 跟隨 CheckBox，文字顯示 `音效 - 70%` 或 `音效 - 關閉`
  - CheckedChanged / Scroll：即時更新 UI
  - BeforClose：寫入 NesCore 並立即生效

---

### 7. Xbox 手把不相容問題調查（待處理）

確認目前 WinMM joyGetPos 無法偵測 XInput 裝置（Xbox 手把）。  
詳見：`bugfix/2026-02-25_XINPUT_ISSUE.md`  
Todo 已登記，預計改為 XInput + WinMM 雙 API 並行。

---

## Git 記錄

| commit | 說明 |
|--------|------|
| fc622a5 | backup: before keyboard polling refactor |
| f9b9164 | fix: 改用 GetAsyncKeyState 每幀輪詢鍵盤（後來還原） |
| dc3601f | revert: 還原鍵盤處理為原始 event-driven 方式 |
| 685f66e | docs: 新增鍵盤多鍵同壓調查報告與測試工具 |
| 19de8a0 | fix: 改善無音效狀態下 FPS 限制精確性 |
| daa1758 | fix: 改善 FPS 統計顯示精確性 |
| b4421bd | fix: 移除所有編譯警告 |
| 4ed43e8 | feat: 音效音量設定 UI 接線完成 |
