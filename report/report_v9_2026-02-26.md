# 2026-02-26 é–‹ç™¼æ—¥èªŒ

## æœ¬æ¬¡æ”¹å‹•æ‘˜è¦

### 1. ç§»é™¤å¤šé¤˜çš„ `using` å®£å‘Šï¼ˆNesCore/*.csï¼‰

æƒæ NesCore æ‰€æœ‰ `.cs` æª”æ¡ˆï¼Œç§»é™¤å¯¦éš›æœªä½¿ç”¨çš„å‘½åç©ºé–“å¼•ç”¨ï¼š

| æª”æ¡ˆ | ç§»é™¤çš„ using |
|------|-------------|
| `CPU.cs` | `System.Windows.Forms` |
| `MEM.cs` | `System.Collections.Generic`ã€`System.Runtime.InteropServices` |
| `Main.cs` | `System.Drawing`ã€`WINAPIGDI`ã€`XBRz_speed` |

ç·¨è­¯ç¢ºèªç„¡èª¤å¾Œ commitã€‚

---

### 2. NesCore ç³»çµ±å±¤é‡æ§‹ï¼ˆä¾ MD/NesCore_refactor_proposal.mdï¼‰

**ç›®æ¨™**ï¼šè®“ NesCore æˆç‚ºç´”ç²¹çš„æ¨¡æ“¬é‚è¼¯æ ¸å¿ƒï¼Œç³»çµ±å±¤ï¼ˆéŸ³æ•ˆè¼¸å‡ºã€FPS ç¯€æµã€éŒ¯èª¤é¡¯ç¤ºï¼‰ç”±å¤–éƒ¨è² è²¬ã€‚

#### ğŸ”´ é«˜å„ªå…ˆï¼šAPU éŸ³æ•ˆè¼¸å‡ºç§»å‡º NesCore

**åŸç‹€æ³**ï¼š`APU.cs` åŒæ™‚åŒ…å«éŸ³æ•ˆæ¨¡æ“¬é‚è¼¯èˆ‡ WinMM WaveOut ç³»çµ±å‘¼å«ï¼Œå¼·åˆ¶ç¶å®š Windows å¹³å°ã€‚

**åšæ³•**ï¼š
- æ–°å»º `AprNes/WaveOutPlayer.cs`ï¼š
  - åŒ…å« WaveOut P/Invokeï¼ˆWAVEFORMATEXã€WAVEHDRã€waveOutOpen/Write/Close ç­‰ï¼‰
  - è¨‚é–± `NesCore.AudioSampleReady`ï¼Œæ¥æ”¶ PCM æ¨£æœ¬å¾Œå¡«å…¥ WaveOut buffer æ’­æ”¾
  - `OpenAudio()` / `CloseAudio()` ä½œç‚ºå¤–éƒ¨å‘¼å«ä»‹é¢
  - `timeBeginPeriod(1)` / `timeEndPeriod(1)` åœ¨ OpenAudio/CloseAudio å…§ç®¡ç†
- `APU.cs` æ”¹å‹•ï¼š
  - ç§»é™¤æ‰€æœ‰ WaveOut P/Invokeã€structã€buffer æ¬„ä½ï¼ˆ`_hWaveOut`ã€`_audioBufs` ç­‰ï¼‰
  - ç§»é™¤ `openAudio()`ã€`closeAudio()`ã€`submitBuffer()` æ–¹æ³•
  - æ–°å¢ `static public Action<short> AudioSampleReady`
  - `generateSample()` æ”¹å‘¼å« `AudioSampleReady?.Invoke((short)clamped)`
  - ç§»é™¤ `using System.Runtime.InteropServices` èˆ‡ `using System.Threading`

#### ğŸ”´ é«˜å„ªå…ˆï¼šShowError æ”¹ç”¨ delegateï¼Œç§»é™¤ Windows.Forms ä¾è³´

**åŸç‹€æ³**ï¼š`Main.cs` æœ‰ `using System.Windows.Forms`ï¼Œ`ShowError()` ç›´æ¥å‘¼å« `MessageBox.Show()`ã€‚

**åšæ³•**ï¼š
- æ–°å¢ `static public Action<string> OnError`
- `ShowError()` æ”¹ç‚º `OnError?.Invoke(msg)`ï¼Œä¸å†åˆ†æ”¯åˆ¤æ–· HeadlessMode
- ç§»é™¤ `using System.Windows.Forms`
- UI ç«¯è¨­å®šï¼š`NesCore.OnError = msg => MessageBox.Show(msg);`
- TestRunner è¨­å®šï¼š`NesCore.OnError = msg => Console.Error.WriteLine("ERROR: " + msg);`

#### ğŸŸ¡ ä¸­å„ªå…ˆï¼šFPS ç¯€æµç§»å‡º PPU

**åŸç‹€æ³**ï¼š`PPU.cs` åœ¨ scanline 240 æƒæå®Œå¾Œè‡ªè¡ŒåŸ·è¡Œ Hybrid Sleep é™é€Ÿï¼Œä¸¦æŒæœ‰ Stopwatchã€‚

**åšæ³•**ï¼š
- ç§»é™¤ `PPU.cs` ä¸­çš„ `Stopwatch`ã€`_fpsDeadline`ã€`NES_FRAME_SECONDS`ã€`LimitFPS` æ¬„ä½
- ç§»é™¤ FPS throttle blockï¼ˆ`if (LimitFPS) { ... }`ï¼‰
- ç§»é™¤ `using System.Diagnostics` èˆ‡ `using System.Threading`
- `AprNesUI.cs` çš„ `VideoOutputDeal` handler æ¥æ‰‹ FPS ç¯€æµï¼š
  - æ–°å¢ `_fpsStopWatch`ã€`_fpsDeadline`ã€`NES_FRAME_SECONDS` ç‚º UI æ¬„ä½
  - æ¯æ¬¡ `VideoOutput` äº‹ä»¶è§¸ç™¼æ™‚åŸ·è¡Œ Hybrid Sleep
  - ROM è¼‰å…¥ / Hard Reset æ™‚é‡ç½® deadline ä¸¦ Restart stopwatch

#### ğŸŸ¢ ä½å„ªå…ˆï¼štimeBeginPeriod ç§»è‡³å‘¼å«æ–¹

`timeBeginPeriod(1)` åŸåœ¨ `NesCore.run()` é–‹é ­å‘¼å«ã€‚ç¾å·²ç§»å…¥ `WaveOutPlayer.OpenAudio()` / `WaveOutPlayer.CloseAudio()`ï¼Œ`run()` ä¸å†æŒæœ‰æ­¤ç³»çµ±å‘¼å«ã€‚

---

### é©—è­‰çµæœ

| æŒ‡æ¨™ | ç‹€æ…‹ |
|------|------|
| `NesCore/` å…§æ‰€æœ‰ `.cs` ä¸å« `using System.Windows.Forms` | âœ… |
| `NesCore/` å…§æ‰€æœ‰ `.cs` ä¸å« `DllImport("winmm.dll")` éŸ³æ•ˆè¼¸å‡º | âœ… |
| TestRunner è¨­å®š `AudioEnabled = false` å¯ä¹¾æ·¨åŸ·è¡Œï¼ˆç„¡ `_audioReady` ç¹éï¼‰ | âœ… |
| æ›¿æ›éŸ³æ•ˆå¾Œç«¯åªéœ€ä¿®æ”¹ `WaveOutPlayer.cs` | âœ… |
| Debug x64 build æˆåŠŸï¼Œç„¡ error | âœ… |

---

## Git è¨˜éŒ„

| commit | èªªæ˜ |
|--------|------|
| 2c6ee19 | refactor: å°‡ NesCore ç³»çµ±å±¤ä¾è³´ç§»å‡ºæ ¸å¿ƒ |
