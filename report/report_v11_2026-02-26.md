# 2026-02-26 開發日誌（AprNesAOT UI 移植）

## 本次改動摘要

### 1. AprNesAOT 選單列 + Open 對話框 + 提示文字

**目標**：視窗顯示後完全空白，使用者無任何操作入口。

**做法**：
- `Program.cs`：
  - 加入 Win32 選單列（`CreateMenu` / `AppendMenuW` / `SetMenu`）
  - 加入 `OpenRomDialog()`（`GetOpenFileNameW`，comdlg32.dll）
  - 加入 `WM_COMMAND` 處理（`IDM_FILE_OPEN` / `IDM_FILE_EXIT`）
  - `WM_PAINT` 無 ROM 時以 `DrawTextW` 顯示提示文字
  - 新增 P/Invoke：`GetClientRect`、`DrawTextW`、`GetOpenFileNameW`、`OPENFILENAME` struct、`RECT` struct

---

### 2. AprNesAOT 完整 UI 移植（對應 WinForms 功能）

**目標**：完整移植原始 WinForms UI 所有「基本操作」功能至 Win32 Pure P/Invoke。

**做法**：

#### 選單（4 個主選單）
- **檔案**：開啟 ROM、軟重置、硬重置、結束
- **選項**：音效開關（勾選）、音量子選單（10/30/50/70/90/100% Radio）、限制 FPS（勾選）
- **語言**：從 LangINI 動態產生，勾選目前語言
- **說明**：ROM 資訊、關於

#### 動態行為
- 未載入 ROM 時，「軟重置」「硬重置」「ROM 資訊」為灰色（`EnableMenuItem`）
- 載入 ROM 後自動啟用

#### FPS 顯示
- `SetTimer` WM_TIMER 每秒更新標題列：`AprNes AOT  [rom名.nes]  FPS: 60`

#### 設定讀寫
- 讀寫 `AprNes.ini`（按鍵對應、音效、音量、FPS 限制、語言）
- 格式與原版 WinForms 相同（`key=value` 純文字）

#### 重置
- **軟重置**：`_event.Reset()` → `NesCore.SoftReset()` → `_event.Set()`
- **硬重置**：停止模擬執行緒 → `NesCore.init(_lastRomBytes)` → 重啟執行緒

#### NesCore 新增公開屬性（`Main.cs`）

```csharp
static public int  RomMapper     => mapper;
static public int  RomPrgCount   => PRG_ROM_count;
static public int  RomChrCount   => CHR_ROM_count;
static public bool RomHorizMirror => (ROM_Control_1 & 1) == 0;
static public bool LimitFPS      = false;
```

---

### 3. Bugfix：SetBkMode / SetTextColor DLL 來源錯誤

**現象**：程式啟動後幾秒崩潰：
```
EntryPointNotFoundException: 'SetBkMode' in DLL 'user32.dll'
```

**原因**：`SetBkMode` / `SetTextColor` 屬於 GDI（`gdi32.dll`），誤宣告為 `user32.dll`

**修復**：
```csharp
// before
[DllImport("user32.dll")] static extern nint SetBkMode(...);
// after
[DllImport("gdi32.dll")]  static extern nint SetBkMode(...);
```

---

### 4. 新增 AOT 遷移文件

- `report/dotnet_framework_to_net8_aot_migration.md`
- 涵蓋 11 項 .NET Framework → .NET 8 AOT 相容性問題與解決方案

---

## 修改檔案清單

| 檔案 | 變更 |
|------|------|
| `AprNesAOT/Program.cs` | 重寫：完整 Win32 UI |
| `AprNes/NesCore/Main.cs` | 新增 ROM 資訊 properties、LimitFPS |
| `bugfix/2026-02-26_BUGFIX23.md` | 新增 bugfix 記錄 |
| `report/dotnet_framework_to_net8_aot_migration.md` | 新增遷移指南 |

---

## TODO 狀態

### ✅ 本次完成

- [x] AprNesAOT 視窗選單列
- [x] AprNesAOT File > Open ROM 對話框
- [x] AprNesAOT 無 ROM 提示文字
- [x] AprNesAOT 音效開關 / 音量選單
- [x] AprNesAOT 限制 FPS 選單
- [x] AprNesAOT 語言切換選單
- [x] AprNesAOT 軟重置 / 硬重置
- [x] AprNesAOT ROM 資訊對話框
- [x] AprNesAOT 關於對話框
- [x] AprNesAOT 設定讀寫 (AprNes.ini)
- [x] AprNesAOT FPS 顯示（標題列）
- [x] bugfix: SetBkMode/SetTextColor gdi32.dll
- [x] AOT publish 產生 1.5MB 單一 exe（無需 .NET Runtime）
- [x] 撰寫 .NET Framework → .NET 8 AOT 遷移相容性文件

### 🔲 後續待辦

- [ ] 按鍵設定對話框（目前需手動編輯 AprNes.ini）
- [ ] 搖桿設定對話框（目前 ini 仍可用，但無圖形介面）
- [ ] xBRZ / Scanline 濾鏡（需移植 System.Drawing → GDI 直繪）
- [ ] 截圖功能（Shift+P）
- [ ] 全螢幕模式
- [ ] Marshal.SizeOf 非泛型警告修正（WaveOutPlayer.cs / joystick.cs）

---

## Commits

| Commit | 說明 |
|--------|------|
| `929353e` | AprNesAOT: 加入選單列、Open 對話框、提示文字 |
| `ea3ffd0` | AprNesAOT: 完整 UI 移植 |
| `2d729a1` | bugfix: SetBkMode/SetTextColor 改至 gdi32.dll |
| `22d9f5c` | docs: 新增 AOT 遷移文件 |
| `2026-02-26_BUGFIX23` | bugfix 記錄 |
