# AprNes 測試報告 v5

- 日期: 2026-02-20 21:30 (UTC+8)
- 編譯: Debug (MSBuild 14.0 / .NET Framework 4.6.1)
- 測試方式: Console headless mode (`--wait-result --max-wait 30`)
- ROM 來源: `nes-test-roms-master/checked/`
- 合併 ROM 逾時: `--max-wait 120`

## 總結: 130 PASS / 26 FAIL (156 ROMs)

### 自 v4 以來的變更 (2026-02-20 20:30)

| 項目 | 說明 |
|---|---|
| Fix 1: initAPU() 完整初始化 | power-on 時 $4015=$00, $4017=$00, 所有聲道/envelope/sweep/DMC 歸零 |
| Fix 2: apuSoftReset() 修正 | 保留 ctrmode/apuintflag, 清 IRQ flag, 停用所有聲道 |
| Fix 3: $4017 寫入行為修正 | mode 1 立即 clock length/envelope/sweep; bit6 設定時才清 frame IRQ |
| Fix 4: $4010 DMC IRQ 清除 | disable DMC IRQ 時同時清除 statusdmcint flag |
| Fix 5: PPU $3000 鏡像修正 | $3000-$3EFF 正確鏡像到 $2000-$2EFF |
| ROM 計數修正 | ppu_vbl_nmi 正確計算為 11 個 ROM (合併+10 singles), 總計 156 |

> v4: 120 PASS / 34 FAIL (154 ROMs)。v5 修復 9 個 ROM，無退步。ppu_read_buffer 子測試 #54 也已修復（整體仍 FAIL）。

---

## 各測試套件結果

| 測試套件 | 通過 | 總計 | 狀態 |
|---|---|---|---|
| apu_mixer | 4 | 4 | PASS |
| apu_reset | 5 | 6 | 1 FAIL |
| apu_test | 4 | 9 | 5 FAIL |
| blargg_apu_2005.07.30 | 11 | 11 | PASS |
| blargg_nes_cpu_test5 | 2 | 2 | PASS |
| blargg_ppu_tests_2005 | 5 | 5 | PASS |
| branch_timing_tests | 3 | 3 | PASS |
| cpu_dummy_reads | 1 | 1 | PASS |
| cpu_dummy_writes | 2 | 2 | PASS |
| cpu_exec_space | 1 | 2 | 1 FAIL |
| cpu_interrupts_v2 | 3 | 6 | 3 FAIL |
| cpu_reset | 2 | 2 | PASS |
| cpu_timing_test6 | 1 | 1 | PASS |
| dmc_dma_during_read4 | 5 | 5 | PASS |
| instr_misc | 2 | 5 | 3 FAIL |
| instr_test-v3 | 17 | 17 | PASS |
| instr_test-v5 | 18 | 18 | PASS |
| instr_timing | 1 | 3 | 2 FAIL |
| nes_instr_test | 11 | 11 | PASS |
| oam_read | 1 | 1 | PASS |
| ppu_open_bus | 1 | 1 | PASS |
| ppu_read_buffer | 0 | 1 | 1 FAIL |
| ppu_vbl_nmi | 3 | 11 | 8 FAIL |
| read_joy3 | 4 | 4 | PASS |
| sprdma_and_dmc_dma | 0 | 2 | 2 FAIL |
| sprite_hit_tests | 11 | 11 | PASS |
| sprite_overflow_tests | 5 | 5 | PASS |
| vbl_nmi_timing | 7 | 7 | PASS |

---

## 完全通過的套件 (20/28)

### apu_mixer (4/4)
- dmc.nes, noise.nes, square.nes, triangle.nes

### blargg_apu_2005.07.30 (11/11)
- 01.len_ctr.nes ~ 11.len_reload_timing.nes

### blargg_nes_cpu_test5 (2/2)
- cpu.nes, official.nes

### blargg_ppu_tests_2005 (5/5)
- palette_ram.nes, power_up_palette.nes, sprite_ram.nes, vbl_clear_time.nes, vram_access.nes

### branch_timing_tests (3/3)
- 1.Branch_Basics.nes, 2.Backward_Branch.nes, 3.Forward_Branch.nes

### cpu_dummy_reads (1/1)
- cpu_dummy_reads.nes

### cpu_dummy_writes (2/2)
- cpu_dummy_writes_oam.nes, cpu_dummy_writes_ppumem.nes

### cpu_reset (2/2)
- registers.nes, ram_after_reset.nes

### cpu_timing_test6 (1/1)
- cpu_timing_test.nes

### dmc_dma_during_read4 (5/5)
- dma_2007_read.nes, dma_2007_write.nes, dma_4016_read.nes, double_2007_read.nes, read_write_2007.nes

### instr_test-v3 (17/17)
- all_instrs.nes, official_only.nes, rom_singles 01~15

### instr_test-v5 (18/18)
- all_instrs.nes, official_only.nes, rom_singles 01~16

### nes_instr_test (11/11)
- rom_singles 01~11

### oam_read (1/1)
- oam_read.nes

### ppu_open_bus (1/1)
- ppu_open_bus.nes

### read_joy3 (4/4)
- test_buttons.nes, count_errors.nes, count_errors_fast.nes, thorough_test.nes

### sprite_hit_tests (11/11)
- 01.basics ~ 11.edge_timing

### sprite_overflow_tests (5/5)
- 1.Basics ~ 5.Emulator

### vbl_nmi_timing (7/7)
- 1.frame_basics ~ 7.nmi_timing

---

## 本次新通過的 ROM (9 個)

| ROM | 修復原因 |
|---|---|
| apu_reset/4015_cleared.nes | Fix 1: initAPU() 正確設定 $4015=$00 |
| apu_reset/4017_timing.nes | Fix 2: apuSoftReset() 清 IRQ flag |
| apu_reset/irq_flag_cleared.nes | Fix 2: apuSoftReset() 清 statusframeint/statusdmcint |
| apu_reset/len_ctrs_enabled.nes | Fix 1: initAPU() lenCtrEnable=false |
| apu_reset/works_immediately.nes | Fix 1: initAPU() 正確初始狀態 |
| apu_test/1-len_ctr.nes | Fix 3: $4017 mode 1 立即 clock length counter |
| apu_test/2-len_table.nes | Fix 1: initAPU() 正確初始化 length table |
| apu_test/3-irq_flag.nes | Fix 3: $4017 bit6 條件清除 frame IRQ flag |
| apu_test/7-dmc_basics.nes | Fix 4: $4010 disable 時清除 DMC IRQ flag |

另外: ppu_read_buffer 子測試 #54 (PPU $3000-$3EFF 鏡像) 已修復，但整體仍 FAIL（剩 #65, #67, #69）。

---

## 失敗詳情 (26 ROMs)

### 分類 1: PPU VBL/NMI 子掃描線時序 (8)

| ROM | 錯誤訊息 |
|---|---|
| ppu_vbl_nmi.nes | 合併 ROM, 在 test 2/10 (vbl_set_time) 失敗 |
| 02-vbl_set_time.nes | VBL flag 設定時序差 1 PPU cycle |
| 03-vbl_clear_time.nes | VBL flag 清除時序不準 |
| 04-nmi_control.nes | "Immediate occurence should be after NEXT instruction" (#11) |
| 06-suppression.nes | VBL 讀取抑制時序不正確 |
| 07-nmi_on_timing.nes | NMI 啟用時序偏差 |
| 08-nmi_off_timing.nes | NMI 停用時序偏差 |
| 10-even_odd_timing.nes | "Clock is skipped too late" |

> 根本原因: PPU VBL flag 設定/清除和 NMI 啟用/停用需要 sub-scanline 級別的 cycle-accurate CPU/PPU 同步。

### 分類 2: CPU Dummy Read / PPU 互動 (4)

| ROM | 錯誤訊息 | 備註 |
|---|---|---|
| cpu_exec_space_apu.nes | FAIL(2) | 需要 CPU fetch 經由 IO_read |
| instr_misc.nes | FAIL(128) — 合併 ROM 逾時 | 官方 opcode 通過, 卡在非官方 opcode |
| 03-dummy_reads.nes | FAIL(4) — "STA abs,x" | PPU 副作用問題 |
| 04-dummy_reads_apu.nes | FAIL(2) — 僅非官方 opcode | **所有官方 opcode 通過** |

### 分類 3: CPU 中斷 + DMA 互動 (3)

| ROM | 錯誤訊息 |
|---|---|
| cpu_interrupts.nes | 合併 ROM, 在 test 4/5 (irq_and_dma) 失敗 |
| 4-irq_and_dma.nes | IRQ + OAM DMA cycle 精度 |
| 5-branch_delays_irq.nes | Branch 指令延遲 IRQ cycle 計數 |

### 分類 4: 指令時序 — 非官方 Opcode (2)

| ROM | 錯誤訊息 |
|---|---|
| instr_timing.nes | FAIL(1) — 非官方指令時序 |
| 1-instr_timing.nes | FAIL(4) — 8B/93/9B/9F/BB timing=0 |

### 分類 5: DMA Cycle 精度 (2)

| ROM | 錯誤訊息 |
|---|---|
| sprdma_and_dmc_dma.nes | FAIL(1) — OAM+DMC DMA cycle 衝突, 全顯示 399 |
| sprdma_and_dmc_dma_512.nes | FAIL(1) — 同上 |

### 分類 6: PPU 讀取緩衝區 + DMA (1)

| ROM | 錯誤訊息 |
|---|---|
| test_ppu_read_buffer.nes | FAIL — 3 個子測試失敗 (#65, #67, #69) |

> 備註: #54 已修復 (Fix 5 PPU $3000 鏡像)。剩餘 #65/#67/#69 為 DMA 從 ROM 讀取相關。

### 分類 7: APU 重置/初始化 (1)

| ROM | 錯誤訊息 |
|---|---|
| 4017_written.nes | FAIL(2) — "At power, $4017 should be written with $00" |

> 根本原因: power-on 時應自動執行一次 $4017 寫入 $00 的效果 (模式 0 啟動、frame counter 重置)。目前 initAPU() 雖設定正確初始值，但未觸發 frame counter 重置序列。

### 分類 8: APU Frame Counter 時序 (5)

| ROM | 錯誤訊息 |
|---|---|
| apu_test.nes | 合併 ROM, 在 test 4/8 (jitter) 失敗 |
| 4-jitter.nes | FAIL(3) — "Frame irq is set too late" |
| 5-len_timing.nes | FAIL(3) — "First length of mode 0 is too late" |
| 6-irq_flag_timing.nes | FAIL(3) — "Flag first set too late" |
| 8-dmc_rates.nes | FAIL(3) — "Rate 0's period is too long" |

> 根本原因: APU frame counter 的精確時序需要進一步調整：
> - Frame IRQ 觸發時機偏晚
> - Mode 0 的 length clock 觸發時機偏晚
> - APU clock jitter (奇偶 cycle 延遲) 未處理
> - DMC rate 0 的 period 不正確

---

## 未來修復優先順序

| 優先級 | 項目 | 影響 ROM 數 | 難度 | 備註 |
|---|---|---|---|---|
| 1 | APU $4017 power-on 寫入模擬 | 1 | 低 | 4017_written |
| 2 | APU frame counter 精確時序 | 5 | 中高 | jitter, len_timing, irq_flag_timing |
| 3 | DMC rate period 修正 | 1 | 低 | 8-dmc_rates |
| 4 | 非官方 opcode 時序 | 2 | 中 | ~20 未實作的 illegal opcodes |
| 5 | CPU fetch via IO_read | 1 | 中 | cpu_exec_space_apu |
| 6 | PPU DMA 讀取 ROM | 1 | 低中 | ppu_read_buffer #65/#67/#69 |
| 7 | OAM DMA + DMC DMA 交錯 | 2 | 高 | sprdma_and_dmc_dma |
| 8 | IRQ + DMA 互動時序 | 3 | 高 | cycle-accurate OAM DMA |
| 9 | PPU sub-cycle VBL/NMI | 8 | 極高 | cycle-accurate CPU/PPU 同步 |

---

## 測試設定備註

- **cpu_reset**: 使用自動偵測 `$6000==$81` 協定 (無顯式 `--soft-reset`)
- **read_joy3/test_buttons.nes**: 需要 `--input "Start:2.0,A:4.0,B:6.0,Select:8.0,Up:10.0,Down:12.0,Left:14.0,Right:16.0"` 和 `--max-wait 60`
- **合併 ROM**: 使用 `--max-wait 120`

## 檔案索引

| 檔案 | 說明 |
|---|---|
| `report/results_v5.log` | 完整測試輸出 (本次) |
| `report/report_v4_2026-02-20.md` | 上一份報告 (v4, 120/34, 154 ROMs) |
| `report/report_v3_2026-02-20.md` | 之前的報告 (v3, 105/19, 124 ROMs) |
