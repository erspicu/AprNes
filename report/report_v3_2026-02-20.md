# AprNes Test Report v3

- Date: 2026-02-20 19:50 (UTC+8)
- Build: Debug (MSBuild 14.0 / .NET Framework 4.6.1)
- Test Runner: Console headless mode (`--wait-result --max-wait 30`)
- ROM Source: `nes-test-roms-master/checked/`
- Merged ROM timeout: `--max-wait 120`

## Summary: 105 PASS / 19 FAIL (124 ROMs)

### Changes since v2 (2026-02-20 earlier)

| Item | Description |
|---|---|
| Reset crash fix | `SoftReset()` no longer calls `closeAudio()`/`initAPU()` from UI thread |
| APU soft reset | New `apuSoftReset()` resets channels without touching WaveOut device |
| Hard Reset UI | Added "Hard Reset" to context menu (full power-cycle re-init) |
| Debug log separation | `dbgInit()` now only creates log in HeadlessMode |
| TestRunner: --soft-reset | Explicit soft reset at given time (seconds) |
| TestRunner: --input | Simulated joypad input: `"A:1.0,B:2.0,Start:3.0,..."` |
| TestRunner: auto $81 | Auto-detect blargg `$6000==$81` (reset request) with 6-frame delay |
| New test suites | cpu_reset, sprdma_and_dmc_dma, dmc_dma_during_read4, read_joy3, ppu_read_buffer |

> v2 had 95 PASS / 17 FAIL (112 ROMs). v3 adds 12 new ROMs and all previously-passing tests remain passing.

---

## Test Suite Results

| Test Suite | Pass | Total | Status |
|---|---|---|---|
| blargg_nes_cpu_test5 | 2 | 2 | PASS |
| blargg_ppu_tests_2005 | 5 | 5 | PASS |
| branch_timing_tests | 3 | 3 | PASS |
| cpu_dummy_reads | 1 | 1 | PASS |
| cpu_dummy_writes | 2 | 2 | PASS |
| cpu_exec_space | 1 | 2 | 1 FAIL |
| cpu_interrupts_v2 | 4 | 6 | 2 FAIL |
| cpu_reset | 2 | 2 | PASS |
| cpu_timing_test6 | 1 | 1 | PASS |
| dmc_dma_during_read4 | 5 | 5 | PASS |
| instr_misc | 2 | 5 | 3 FAIL |
| instr_test-v3 | 17 | 17 | PASS |
| instr_test-v5 | 18 | 18 | PASS |
| instr_timing | 1 | 3 | 2 FAIL |
| nes_instr_test | 11 | 11 | PASS |
| oam_read | 1 | 1 | PASS |
| ppu_open_bus | 1 | 1 | PASS |
| ppu_read_buffer | 0 | 1 | 1 FAIL |
| ppu_vbl_nmi | 3 | 10 | 7 FAIL |
| read_joy3 | 4 | 4 | PASS |
| sprdma_and_dmc_dma | 0 | 2 | 2 FAIL |
| sprite_hit_tests | 11 | 11 | PASS |
| sprite_overflow_tests | 5 | 5 | PASS |
| vbl_nmi_timing | 7 | 7 | PASS |

---

## Fully Passing Suites (17/24)

### blargg_nes_cpu_test5 (2/2)
- cpu.nes, official.nes

### blargg_ppu_tests_2005 (5/5)
- palette_ram.nes, power_up_palette.nes, sprite_ram.nes, vbl_clear_time.nes, vram_access.nes

### branch_timing_tests (3/3)
- 1.Branch_Basics.nes, 2.Backward_Branch.nes, 3.Forward_Branch.nes

### cpu_dummy_reads (1/1)
- cpu_dummy_reads.nes

### cpu_dummy_writes (2/2)
- cpu_dummy_writes_oam.nes, cpu_dummy_writes_ppumem.nes

### cpu_reset (2/2) -- NEW
- registers.nes (auto-detect $81 at frame 136, soft reset at frame 142)
- ram_after_reset.nes (auto-detect $81 at frame 134, soft reset at frame 140)

### cpu_timing_test6 (1/1)
- cpu_timing_test.nes

### dmc_dma_during_read4 (5/5) -- NEW
- dma_2007_read.nes, dma_2007_write.nes, dma_4016_read.nes, double_2007_read.nes, read_write_2007.nes

### instr_test-v3 (17/17)
- all_instrs.nes, official_only.nes, rom_singles 01~15

### instr_test-v5 (18/18)
- all_instrs.nes, official_only.nes, rom_singles 01~16

### nes_instr_test (11/11)
- rom_singles 01~11

### oam_read (1/1)
- oam_read.nes

### ppu_open_bus (1/1)
- ppu_open_bus.nes

### read_joy3 (4/4) -- NEW
- test_buttons.nes (with `--input "Start:2.0,A:4.0,B:6.0,Select:8.0,Up:10.0,Down:12.0,Left:14.0,Right:16.0"`)
- count_errors.nes, count_errors_fast.nes, thorough_test.nes

### sprite_hit_tests (11/11)
- 01.basics ~ 11.edge_timing

### sprite_overflow_tests (5/5)
- 1.Basics ~ 5.Emulator

### vbl_nmi_timing (7/7)
- 1.frame_basics ~ 7.nmi_timing

---

## Failure Details (19 ROMs)

### Category 1: PPU VBL/NMI Sub-Scanline Timing (7)

| ROM | Error |
|---|---|
| ppu_vbl_nmi.nes | Merged ROM, fails at test 2/10 (vbl_set_time) |
| 02-vbl_set_time.nes | VBL flag set timing off by 1 PPU cycle |
| 03-vbl_clear_time.nes | VBL flag clear timing inaccurate |
| 04-nmi_control.nes | "Immediate occurence should be after NEXT instruction" (#11) |
| 06-suppression.nes | VBL read suppression timing incorrect |
| 07-nmi_on_timing.nes | NMI enable timing off |
| 08-nmi_off_timing.nes | NMI disable timing off |

> Root cause: PPU VBL flag set/clear and NMI enable/disable timing at sub-scanline level need cycle-accurate CPU/PPU synchronization.

### Category 2: CPU Dummy Read / PPU Interaction (5)

| ROM | Error | Notes |
|---|---|---|
| cpu_exec_space/test_cpu_exec_space_apu.nes | FAIL(2) — APU I/O exec jumps to wrong address | Needs CPU fetch via IO_read |
| instr_misc/instr_misc.nes | FAIL(128) — merged ROM timeout at test 4 | Official opcodes pass; stuck on unofficial |
| instr_misc/03-dummy_reads.nes | FAIL(4) — "STA abs,x" PPU dummy read | PPU side-effect issue |
| instr_misc/04-dummy_reads_apu.nes | FAIL(2) — unofficial opcodes only | **All official opcodes pass** |
| ppu_vbl_nmi/10-even_odd_timing.nes | FAIL(3) — "Clock is skipped too late" (08 vs 07) | Needs cycle-accurate sync |

### Category 3: CPU Interrupt + DMA Interaction (3)

| ROM | Error |
|---|---|
| cpu_interrupts_v2/cpu_interrupts.nes | Merged ROM, fails at test 4/5 (irq_and_dma) |
| cpu_interrupts_v2/4-irq_and_dma.nes | IRQ + OAM DMA cycle precision |
| cpu_interrupts_v2/5-branch_delays_irq.nes | Branch instruction delays IRQ cycle count |

> Root cause: OAM DMA IRQ sampling timing and branch page-cross IRQ delay behavior. Needs cycle-accurate DMA.

### Category 4: Instruction Timing -- Illegal Opcodes (2)

| ROM | Error | Notes |
|---|---|---|
| instr_timing/instr_timing.nes | FAIL(1) — unofficial instruction timing | NOP page-cross fixed; remaining are unimplemented |
| instr_timing/1-instr_timing.nes | FAIL(4) — 8B/93/9B/9F/BB timing=0 | Same as above |

> Only unimplemented unofficial opcodes (8B, 93, 9B, 9F, B3 cross, BB, BF cross) remain.

### Category 5: DMA Cycle Accuracy (2) -- NEW

| ROM | Error |
|---|---|
| sprdma_and_dmc_dma/sprdma_and_dmc_dma.nes | FAIL(1) — OAM DMA + DMC DMA cycle conflict, all timings show 399 |
| sprdma_and_dmc_dma/sprdma_and_dmc_dma_512.nes | FAIL(1) — same as above |

> Root cause: OAM DMA does not account for DMC DMA stealing cycles. Needs DMA cycle interleaving implementation.

### Category 6: PPU Read Buffer + DMA (1) -- NEW

| ROM | Error |
|---|---|
| ppu_read_buffer/test_ppu_read_buffer.nes | FAIL(54) — 4 sub-tests failed (#54, #65, #67, #69) |

> Details: "Hi" column passes for DMA, "No-Hi" column fails with "??21" for DMA with ROM and mirrors. Also fails DMA with $1400-$1F00 in "Hi" column. Sub-test #54: "PPU memory range 3000-3EFE should be a mirror of 2000-2EFE."

---

## Future Fix Priorities

| Priority | Item | Failing ROMs | Difficulty | Notes |
|---|---|---|---|---|
| 1 | Unofficial opcode timing | 2 | Medium | ~20 unimplemented illegal opcodes |
| 2 | CPU fetch via IO_read | 1 | Medium | cpu_exec_space_apu |
| 3 | PPU $3000-$3EFE mirror | 1 | Low | ppu_read_buffer #54 |
| 4 | OAM DMA + DMC DMA interleave | 2 | High | sprdma_and_dmc_dma |
| 5 | IRQ + DMA interaction timing | 3 | High | Cycle-accurate OAM DMA |
| 6 | PPU sub-cycle VBL/NMI | 8 | Very High | Cycle-accurate CPU/PPU sync |

---

## Test Configuration Notes

- **cpu_reset**: Uses auto-detect `$6000==$81` protocol (no explicit `--soft-reset`). The auto-detect triggers soft reset 6 frames (~100ms) after detecting $81.
- **read_joy3/test_buttons.nes**: Requires `--input "Start:2.0,A:4.0,B:6.0,Select:8.0,Up:10.0,Down:12.0,Left:14.0,Right:16.0"` and `--max-wait 60`
- **Merged ROMs** (all_instrs.nes, official_only.nes, instr_timing.nes, etc.): Use `--max-wait 120`

## File Index

| File | Description |
|---|---|
| `report/results_full.log` | Full test output log (this run) |
| `report/screenshots/` | Screenshots for all test ROMs |
| `report/report_v2_2026-02-20.md` | Previous report (v2, 95/17, before new suites) |
| `report/results_v2_2026-02-20.log` | Previous results log (v2) |
